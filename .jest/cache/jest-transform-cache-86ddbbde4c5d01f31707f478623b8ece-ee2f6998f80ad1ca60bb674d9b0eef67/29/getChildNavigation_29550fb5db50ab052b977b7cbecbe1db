616b238acb61f04128fe6bfa09c98821
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _getChildEventSubscriber = _interopRequireDefault(require("./getChildEventSubscriber"));

var _getChildRouter = _interopRequireDefault(require("./getChildRouter"));

var _getNavigationActionCreators = _interopRequireDefault(require("./routers/getNavigationActionCreators"));

var _getChildrenNavigationCache = _interopRequireDefault(require("./getChildrenNavigationCache"));

var createParamGetter = function createParamGetter(route) {
  return function (paramName, defaultValue) {
    var params = route.params;

    if (params && paramName in params) {
      return params[paramName];
    }

    return defaultValue;
  };
};

function _getChildNavigation(navigation, childKey, getCurrentParentNavigation) {
  var children = (0, _getChildrenNavigationCache.default)(navigation);
  var childRoute = navigation.state.routes.find(function (r) {
    return r.key === childKey;
  });

  if (!childRoute) {
    return null;
  }

  if (children[childKey] && children[childKey].state === childRoute) {
    return children[childKey];
  }

  var childRouter = (0, _getChildRouter.default)(navigation.router, childRoute.routeName);
  var focusedGrandChildRoute = childRoute.routes && typeof childRoute.index === 'number' ? childRoute.routes[childRoute.index] : null;
  var actionCreators = (0, _objectSpread2.default)({}, navigation.actions, navigation.router.getActionCreators(childRoute, navigation.state.key), childRouter ? childRouter.getActionCreators(focusedGrandChildRoute, childRoute.key) : {}, (0, _getNavigationActionCreators.default)(childRoute));
  var actionHelpers = {};
  Object.keys(actionCreators).forEach(function (actionName) {
    actionHelpers[actionName] = function () {
      var actionCreator = actionCreators[actionName];
      var action = actionCreator.apply(void 0, arguments);
      return navigation.dispatch(action);
    };
  });
  var _isFirstRouteInParent = true;
  var parentNavigation = getCurrentParentNavigation();

  if (parentNavigation) {
    _isFirstRouteInParent = parentNavigation.state.routes.indexOf(childRoute) === 0;
  }

  if (children[childKey] && children[childKey].isFirstRouteInParent() === _isFirstRouteInParent) {
    children[childKey] = (0, _objectSpread2.default)({}, children[childKey], actionHelpers, {
      state: childRoute,
      router: childRouter,
      actions: actionCreators,
      getParam: createParamGetter(childRoute)
    });
    return children[childKey];
  } else {
    var childSubscriber = (0, _getChildEventSubscriber.default)(navigation.addListener, childKey);
    children[childKey] = (0, _objectSpread2.default)({}, actionHelpers, {
      state: childRoute,
      router: childRouter,
      actions: actionCreators,
      getParam: createParamGetter(childRoute),
      getChildNavigation: function getChildNavigation(grandChildKey) {
        return _getChildNavigation(children[childKey], grandChildKey, function () {
          var nav = getCurrentParentNavigation();
          return nav && nav.getChildNavigation(childKey);
        });
      },
      isFocused: function isFocused() {
        var currentNavigation = getCurrentParentNavigation();

        if (!currentNavigation) {
          return false;
        }

        var _currentNavigation$st = currentNavigation.state,
            routes = _currentNavigation$st.routes,
            index = _currentNavigation$st.index;

        if (!currentNavigation.isFocused()) {
          return false;
        }

        if (routes[index].key === childKey) {
          return true;
        }

        return false;
      },
      isFirstRouteInParent: function isFirstRouteInParent() {
        return _isFirstRouteInParent;
      },
      dispatch: navigation.dispatch,
      getScreenProps: navigation.getScreenProps,
      dangerouslyGetParent: getCurrentParentNavigation,
      addListener: childSubscriber.addListener,
      emit: childSubscriber.emit
    });
    return children[childKey];
  }
}

var _default = _getChildNavigation;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdldENoaWxkTmF2aWdhdGlvbi5qcyJdLCJuYW1lcyI6WyJjcmVhdGVQYXJhbUdldHRlciIsInBhcmFtcyIsInJvdXRlIiwicGFyYW1OYW1lIiwiY2hpbGRyZW4iLCJjaGlsZFJvdXRlIiwibmF2aWdhdGlvbiIsInIiLCJjaGlsZFJvdXRlciIsImZvY3VzZWRHcmFuZENoaWxkUm91dGUiLCJhY3Rpb25DcmVhdG9ycyIsImFjdGlvbkhlbHBlcnMiLCJPYmplY3QiLCJhY3Rpb25DcmVhdG9yIiwiYWN0aW9uIiwiaXNGaXJzdFJvdXRlSW5QYXJlbnQiLCJwYXJlbnROYXZpZ2F0aW9uIiwiZ2V0Q3VycmVudFBhcmVudE5hdmlnYXRpb24iLCJzdGF0ZSIsInJvdXRlciIsImFjdGlvbnMiLCJnZXRQYXJhbSIsImNoaWxkU3Vic2NyaWJlciIsImdldENoaWxkTmF2aWdhdGlvbiIsIm5hdiIsImlzRm9jdXNlZCIsImN1cnJlbnROYXZpZ2F0aW9uIiwicm91dGVzIiwiaW5kZXgiLCJkaXNwYXRjaCIsImdldFNjcmVlblByb3BzIiwiZGFuZ2Vyb3VzbHlHZXRQYXJlbnQiLCJhZGRMaXN0ZW5lciIsImVtaXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLElBQUEsd0JBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSwyQkFBQSxDQUFBLENBQUE7O0FBQ0EsSUFBQSxlQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLENBQUEsa0JBQUEsQ0FBQSxDQUFBOztBQUNBLElBQUEsNEJBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSx1Q0FBQSxDQUFBLENBQUE7O0FBQ0EsSUFBQSwyQkFBQSxHQUFBLHNCQUFBLENBQUEsT0FBQSxDQUFBLDhCQUFBLENBQUEsQ0FBQTs7QUFFQSxJQUFNQSxpQkFBaUIsR0FBakJBLFNBQUFBLGlCQUFBQSxDQUFvQixLQUFwQkEsRUFBeUI7QUFBQSxTQUFJLFVBQUEsU0FBQSxFQUFBLFlBQUEsRUFBNkI7QUFDOUQsUUFBTUMsTUFBTSxHQUFH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QUExQixFQUFBOztBQUNBLFlBQUksQ0FBSixpQkFBQSxFQUF3QjtBQUN0QixpQkFBQSxLQUFBO0FBSGE7O0FBQUEsWUFBQSxxQkFBQSxHQUtXUyxpQkFBaUIsQ0FMNUIsS0FBQTtBQUFBLFlBS1BDLE1BTE8sR0FBQSxxQkFBQSxDQUFBLE1BQUE7QUFBQSxZQUtDQyxLQUxELEdBQUEscUJBQUEsQ0FBQSxLQUFBOztBQU1mLFlBQUksQ0FBQ0YsaUJBQWlCLENBQXRCLFNBQUtBLEVBQUwsRUFBb0M7QUFDbEMsaUJBQUEsS0FBQTtBQUVGOztBQUFBLFlBQUlDLE1BQU0sQ0FBTkEsS0FBTSxDQUFOQSxDQUFBQSxHQUFBQSxLQUFKLFFBQUEsRUFBb0M7QUFDbEMsaUJBQUEsSUFBQTtBQUVGOztBQUFBLGVBQUEsS0FBQTtBQTFCSnZCLE9BQUFBO0FBNEJFVyxNQUFBQSxvQkFBb0IsRUFBRSxTQUFBLG9CQUFBLEdBQUE7QUFBQSxlQUFBLHFCQUFBO0FBNUJ4QlgsT0FBQUE7QUE2QkV5QixNQUFBQSxRQUFRLEVBQUV2QixVQUFVLENBN0J0QkYsUUFBQUE7QUE4QkUwQixNQUFBQSxjQUFjLEVBQUV4QixVQUFVLENBOUI1QkYsY0FBQUE7QUErQkUyQixNQUFBQSxvQkFBb0IsRUEvQnRCM0IsMEJBQUFBO0FBZ0NFNEIsTUFBQUEsV0FBVyxFQUFFVixlQUFlLENBaEM5QmxCLFdBQUFBO0FBaUNFNkIsTUFBQUEsSUFBSSxFQUFFWCxlQUFlLENBakN2QmxCO0FBQUFBLEtBQUFBLENBQUFBO0FBbUNBLFdBQU9BLFFBQVEsQ0FBZixRQUFlLENBQWY7QUFFSDs7O2VBRWNtQixtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBnZXRDaGlsZEV2ZW50U3Vic2NyaWJlciBmcm9tICcuL2dldENoaWxkRXZlbnRTdWJzY3JpYmVyJztcbmltcG9ydCBnZXRDaGlsZFJvdXRlciBmcm9tICcuL2dldENoaWxkUm91dGVyJztcbmltcG9ydCBnZXROYXZpZ2F0aW9uQWN0aW9uQ3JlYXRvcnMgZnJvbSAnLi9yb3V0ZXJzL2dldE5hdmlnYXRpb25BY3Rpb25DcmVhdG9ycyc7XG5pbXBvcnQgZ2V0Q2hpbGRyZW5OYXZpZ2F0aW9uQ2FjaGUgZnJvbSAnLi9nZXRDaGlsZHJlbk5hdmlnYXRpb25DYWNoZSc7XG5cbmNvbnN0IGNyZWF0ZVBhcmFtR2V0dGVyID0gcm91dGUgPT4gKHBhcmFtTmFtZSwgZGVmYXVsdFZhbHVlKSA9PiB7XG4gIGNvbnN0IHBhcmFtcyA9IHJvdXRlLnBhcmFtcztcblxuICBpZiAocGFyYW1zICYmIHBhcmFtTmFtZSBpbiBwYXJhbXMpIHtcbiAgICByZXR1cm4gcGFyYW1zW3BhcmFtTmFtZV07XG4gIH1cblxuICByZXR1cm4gZGVmYXVsdFZhbHVlO1xufTtcblxuZnVuY3Rpb24gZ2V0Q2hpbGROYXZpZ2F0aW9uKG5hdmlnYXRpb24sIGNoaWxkS2V5LCBnZXRDdXJyZW50UGFyZW50TmF2aWdhdGlvbikge1xuICBjb25zdCBjaGlsZHJlbiA9IGdldENoaWxkcmVuTmF2aWdhdGlvbkNhY2hlKG5hdmlnYXRpb24pO1xuICBjb25zdCBjaGlsZFJvdXRlID0gbmF2aWdhdGlvbi5zdGF0ZS5yb3V0ZXMuZmluZChyID0+IHIua2V5ID09PSBjaGlsZEtleSk7XG5cbiAgaWYgKCFjaGlsZFJvdXRlKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBpZiAoY2hpbGRyZW5bY2hpbGRLZXldICYmIGNoaWxkcmVuW2NoaWxkS2V5XS5zdGF0ZSA9PT0gY2hpbGRSb3V0ZSkge1xuICAgIHJldHVybiBjaGlsZHJlbltjaGlsZEtleV07XG4gIH1cblxuICBjb25zdCBjaGlsZFJvdXRlciA9IGdldENoaWxkUm91dGVyKG5hdmlnYXRpb24ucm91dGVyLCBjaGlsZFJvdXRlLnJvdXRlTmFtZSk7XG5cbiAgLy8gSWYgdGhlIHJvdXRlIGhhcyBjaGlsZHJlbiwgd2UnbGwgdXNlIHRoaXMgdG8gcGFzcyBpbiB0byB0aGUgYWN0aW9uIGNyZWF0b3JzXG4gIC8vIGZvciB0aGUgY2hpbGRSb3V0ZXIgc28gdGhhdCBhbnkgYWN0aW9uIHRoYXQgZGVwZW5kcyBvbiB0aGUgYWN0aXZlIHJvdXRlIHdpbGxcbiAgLy8gYmVoYXZlIGFzIGV4cGVjdGVkLiBXZSBkb24ndCBleHBsaWNpdGx5IHJlcXVpcmUgdGhhdCByb3V0ZXJzIGltcGxlbWVudCByb3V0ZXNcbiAgLy8gYW5kIGluZGV4IHByb3BlcnRpZXMsIGJ1dCBpZiB3ZSBkaWQgdGhlbiB3ZSB3b3VsZCBwdXQgYW4gaW52YXJpYW50IGhlcmUgdG9cbiAgLy8gZW5zdXJlIHRoYXQgYSBmb2N1c2VkR3JhbmRDaGlsZFJvdXRlIGV4aXN0cyBpZiBjaGlsZFJvdXRlciBpcyBkZWZpbmVkLlxuICBjb25zdCBmb2N1c2VkR3JhbmRDaGlsZFJvdXRlID1cbiAgICBjaGlsZFJvdXRlLnJvdXRlcyAmJiB0eXBlb2YgY2hpbGRSb3V0ZS5pbmRleCA9PT0gJ251bWJlcidcbiAgICAgID8gY2hpbGRSb3V0ZS5yb3V0ZXNbY2hpbGRSb3V0ZS5pbmRleF1cbiAgICAgIDogbnVsbDtcblxuICBjb25zdCBhY3Rpb25DcmVhdG9ycyA9IHtcbiAgICAuLi5uYXZpZ2F0aW9uLmFjdGlvbnMsXG4gICAgLi4ubmF2aWdhdGlvbi5yb3V0ZXIuZ2V0QWN0aW9uQ3JlYXRvcnMoY2hpbGRSb3V0ZSwgbmF2aWdhdGlvbi5zdGF0ZS5rZXkpLFxuICAgIC4uLihjaGlsZFJvdXRlclxuICAgICAgPyBjaGlsZFJvdXRlci5nZXRBY3Rpb25DcmVhdG9ycyhmb2N1c2VkR3JhbmRDaGlsZFJvdXRlLCBjaGlsZFJvdXRlLmtleSlcbiAgICAgIDoge30pLFxuICAgIC4uLmdldE5hdmlnYXRpb25BY3Rpb25DcmVhdG9ycyhjaGlsZFJvdXRlKSxcbiAgfTtcblxuICBjb25zdCBhY3Rpb25IZWxwZXJzID0ge307XG4gIE9iamVjdC5rZXlzKGFjdGlvbkNyZWF0b3JzKS5mb3JFYWNoKGFjdGlvbk5hbWUgPT4ge1xuICAgIGFjdGlvbkhlbHBlcnNbYWN0aW9uTmFtZV0gPSAoLi4uYXJncykgPT4ge1xuICAgICAgY29uc3QgYWN0aW9uQ3JlYXRvciA9IGFjdGlvbkNyZWF0b3JzW2FjdGlvbk5hbWVdO1xuICAgICAgY29uc3QgYWN0aW9uID0gYWN0aW9uQ3JlYXRvciguLi5hcmdzKTtcbiAgICAgIHJldHVybiBuYXZpZ2F0aW9uLmRpc3BhdGNoKGFjdGlvbik7XG4gICAgfTtcbiAgfSk7XG5cbiAgbGV0IGlzRmlyc3RSb3V0ZUluUGFyZW50ID0gdHJ1ZTtcblxuICBjb25zdCBwYXJlbnROYXZpZ2F0aW9uID0gZ2V0Q3VycmVudFBhcmVudE5hdmlnYXRpb24oKTtcblxuICBpZiAocGFyZW50TmF2aWdhdGlvbikge1xuICAgIGlzRmlyc3RSb3V0ZUluUGFyZW50ID1cbiAgICAgIHBhcmVudE5hdmlnYXRpb24uc3RhdGUucm91dGVzLmluZGV4T2YoY2hpbGRSb3V0ZSkgPT09IDA7XG4gIH1cblxuICBpZiAoXG4gICAgY2hpbGRyZW5bY2hpbGRLZXldICYmXG4gICAgY2hpbGRyZW5bY2hpbGRLZXldLmlzRmlyc3RSb3V0ZUluUGFyZW50KCkgPT09IGlzRmlyc3RSb3V0ZUluUGFyZW50XG4gICkge1xuICAgIGNoaWxkcmVuW2NoaWxkS2V5XSA9IHtcbiAgICAgIC4uLmNoaWxkcmVuW2NoaWxkS2V5XSxcbiAgICAgIC4uLmFjdGlvbkhlbHBlcnMsXG4gICAgICBzdGF0ZTogY2hpbGRSb3V0ZSxcbiAgICAgIHJvdXRlcjogY2hpbGRSb3V0ZXIsXG4gICAgICBhY3Rpb25zOiBhY3Rpb25DcmVhdG9ycyxcbiAgICAgIGdldFBhcmFtOiBjcmVhdGVQYXJhbUdldHRlcihjaGlsZFJvdXRlKSxcbiAgICB9O1xuICAgIHJldHVybiBjaGlsZHJlbltjaGlsZEtleV07XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgY2hpbGRTdWJzY3JpYmVyID0gZ2V0Q2hpbGRFdmVudFN1YnNjcmliZXIoXG4gICAgICBuYXZpZ2F0aW9uLmFkZExpc3RlbmVyLFxuICAgICAgY2hpbGRLZXlcbiAgICApO1xuXG4gICAgY2hpbGRyZW5bY2hpbGRLZXldID0ge1xuICAgICAgLi4uYWN0aW9uSGVscGVycyxcblxuICAgICAgc3RhdGU6IGNoaWxkUm91dGUsXG4gICAgICByb3V0ZXI6IGNoaWxkUm91dGVyLFxuICAgICAgYWN0aW9uczogYWN0aW9uQ3JlYXRvcnMsXG4gICAgICBnZXRQYXJhbTogY3JlYXRlUGFyYW1HZXR0ZXIoY2hpbGRSb3V0ZSksXG5cbiAgICAgIGdldENoaWxkTmF2aWdhdGlvbjogZ3JhbmRDaGlsZEtleSA9PlxuICAgICAgICBnZXRDaGlsZE5hdmlnYXRpb24oY2hpbGRyZW5bY2hpbGRLZXldLCBncmFuZENoaWxkS2V5LCAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgbmF2ID0gZ2V0Q3VycmVudFBhcmVudE5hdmlnYXRpb24oKTtcbiAgICAgICAgICByZXR1cm4gbmF2ICYmIG5hdi5nZXRDaGlsZE5hdmlnYXRpb24oY2hpbGRLZXkpO1xuICAgICAgICB9KSxcblxuICAgICAgaXNGb2N1c2VkOiAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnROYXZpZ2F0aW9uID0gZ2V0Q3VycmVudFBhcmVudE5hdmlnYXRpb24oKTtcbiAgICAgICAgaWYgKCFjdXJyZW50TmF2aWdhdGlvbikge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB7IHJvdXRlcywgaW5kZXggfSA9IGN1cnJlbnROYXZpZ2F0aW9uLnN0YXRlO1xuICAgICAgICBpZiAoIWN1cnJlbnROYXZpZ2F0aW9uLmlzRm9jdXNlZCgpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyb3V0ZXNbaW5kZXhdLmtleSA9PT0gY2hpbGRLZXkpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9LFxuICAgICAgaXNGaXJzdFJvdXRlSW5QYXJlbnQ6ICgpID0+IGlzRmlyc3RSb3V0ZUluUGFyZW50LFxuICAgICAgZGlzcGF0Y2g6IG5hdmlnYXRpb24uZGlzcGF0Y2gsXG4gICAgICBnZXRTY3JlZW5Qcm9wczogbmF2aWdhdGlvbi5nZXRTY3JlZW5Qcm9wcyxcbiAgICAgIGRhbmdlcm91c2x5R2V0UGFyZW50OiBnZXRDdXJyZW50UGFyZW50TmF2aWdhdGlvbixcbiAgICAgIGFkZExpc3RlbmVyOiBjaGlsZFN1YnNjcmliZXIuYWRkTGlzdGVuZXIsXG4gICAgICBlbWl0OiBjaGlsZFN1YnNjcmliZXIuZW1pdCxcbiAgICB9O1xuICAgIHJldHVybiBjaGlsZHJlbltjaGlsZEtleV07XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZ2V0Q2hpbGROYXZpZ2F0aW9uO1xuIl19