c02ee5bc62a6e053af0d3e2338d1c88b
var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createPathParser = exports.urlToPathAndParams = exports.getParamsFromPath = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _pathToRegexp = _interopRequireWildcard(require("path-to-regexp"));

var NavigationActions = _interopRequireWildcard(require("../NavigationActions"));

var _invariant = _interopRequireDefault(require("../utils/invariant"));

var queryString = require('query-string');

var getParamsFromPath = function getParamsFromPath(inputParams, pathMatch, pathMatchKeys) {
  var params = pathMatch.slice(1).reduce(function (paramsOut, matchResult, i) {
    var key = pathMatchKeys[i];

    if (!key || key.asterisk) {
      return paramsOut;
    }

    var paramName = key.name;
    var decodedMatchResult;

    if (matchResult) {
      try {
        decodedMatchResult = decodeURIComponent(matchResult);
      } catch (e) {}
    }

    paramsOut[paramName] = decodedMatchResult || matchResult;
    return paramsOut;
  }, (0, _objectSpread2.default)({}, inputParams));
  return params;
};

exports.getParamsFromPath = getParamsFromPath;

var getRestOfPath = function getRestOfPath(pathMatch, pathMatchKeys) {
  var rest = pathMatch[pathMatchKeys.findIndex(function (k) {
    return k.asterisk;
  }) + 1];
  return rest;
};

var urlToPathAndParams = function urlToPathAndParams(url, uriPrefix) {
  var searchMatch = url.match(/^(.*)\?(.*)$/);
  var params = searchMatch ? queryString.parse(searchMatch[2]) : {};
  var urlWithoutSearch = searchMatch ? searchMatch[1] : url;
  var delimiter = uriPrefix || '://';
  var path = urlWithoutSearch.split(delimiter)[1];

  if (path === undefined) {
    path = urlWithoutSearch;
  }

  if (path === '/') {
    path = '';
  }

  if (path[path.length - 1] === '/') {
    path = path.slice(0, -1);
  }

  return {
    path: path,
    params: params
  };
};

exports.urlToPathAndParams = urlToPathAndParams;

var createPathParser = function createPathParser(childRouters, routeConfigs, _ref) {
  var _ref$paths = _ref.paths,
      pathConfigs = _ref$paths === void 0 ? {} : _ref$paths,
      disableRouteNamePaths = _ref.disableRouteNamePaths;
  var pathsByRouteNames = {};
  var paths = [];
  Object.keys(childRouters).forEach(function (routeName) {
    var pathPattern;

    if (pathConfigs[routeName] !== undefined) {
      pathPattern = pathConfigs[routeName];
    } else {
      pathPattern = routeConfigs[routeName].path;
    }

    if (pathPattern === undefined) {
      pathPattern = disableRouteNamePaths ? null : routeName;
    }

    (0, _invariant.default)(pathPattern === null || typeof pathPattern === 'string', "Route path for " + routeName + " must be specified as a string, or null.");
    var isPathMatchable = pathPattern !== null;
    var exactReKeys = [];
    var exactRe = isPathMatchable ? (0, _pathToRegexp.default)(pathPattern, exactReKeys) : null;
    var extendedPathReKeys = [];
    var isWildcard = pathPattern === '' || !isPathMatchable;
    var extendedPathRe = (0, _pathToRegexp.default)(isWildcard ? '*' : pathPattern + "/*", extendedPathReKeys);
    pathsByRouteNames[routeName] = {
      exactRe: exactRe,
      exactReKeys: exactReKeys,
      extendedPathRe: extendedPathRe,
      extendedPathReKeys: extendedPathReKeys,
      isWildcard: isWildcard,
      toPath: pathPattern === null ? function () {
        return '';
      } : (0, _pathToRegexp.compile)(pathPattern)
    };
  });
  paths = Object.entries(pathsByRouteNames);

  var getActionForPathAndParams = function getActionForPathAndParams() {
    var pathToResolve = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : '';
    var inputParams = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

    for (var _iterator = paths, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[typeof Symbol === "function" ? typeof Symbol === "function" ? Symbol.iterator : "@@iterator" : "@@iterator"]();;) {
      var _ref4;

      if (_isArray) {
        if (_i >= _iterator.length) break;
        _ref4 = _iterator[_i++];
      } else {
        _i = _iterator.next();
        if (_i.done) break;
        _ref4 = _i.value;
      }

      var _ref8 = _ref4;

      var _ref3 = (0, _slicedToArray2.default)(_ref8, 2);

      var _routeName2 = _ref3[0];
      var _path2 = _ref3[1];
      var exactRe = _path2.exactRe,
          exactReKeys = _path2.exactReKeys,
          extendedPathRe = _path2.extendedPathRe,
          extendedPathReKeys = _path2.extendedPathReKeys;
      var childRouter = childRouters[_routeName2];
      var exactMatch = exactRe && exactRe.exec(pathToResolve);

      if (exactMatch && exactMatch.length) {
        var extendedMatch = extendedPathRe && extendedPathRe.exec(pathToResolve);
        var childAction = null;

        if (extendedMatch && childRouter) {
          var restOfPath = getRestOfPath(extendedMatch, extendedPathReKeys);
          childAction = childRouter.getActionForPathAndParams(restOfPath, inputParams);
        }

        return NavigationActions.navigate({
          routeName: _routeName2,
          params: getParamsFromPath(inputParams, exactMatch, exactReKeys),
          action: childAction
        });
      }
    }

    for (var _iterator2 = paths, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[typeof Symbol === "function" ? typeof Symbol === "function" ? Symbol.iterator : "@@iterator" : "@@iterator"]();;) {
      var _ref7;

      if (_isArray2) {
        if (_i2 >= _iterator2.length) break;
        _ref7 = _iterator2[_i2++];
      } else {
        _i2 = _iterator2.next();
        if (_i2.done) break;
        _ref7 = _i2.value;
      }

      var _ref9 = _ref7;

      var _ref6 = (0, _slicedToArray2.default)(_ref9, 2);

      var _routeName3 = _ref6[0];
      var _path3 = _ref6[1];
      var _extendedPathRe = _path3.extendedPathRe,
          _extendedPathReKeys = _path3.extendedPathReKeys;
      var _childRouter = childRouters[_routeName3];

      var _extendedMatch = _extendedPathRe && _extendedPathRe.exec(pathToResolve);

      if (_extendedMatch && _extendedMatch.length) {
        var _restOfPath = getRestOfPath(_extendedMatch, _extendedPathReKeys);

        var _childAction = null;

        if (_childRouter) {
          _childAction = _childRouter.getActionForPathAndParams(_restOfPath, inputParams);
        }

        if (!_childAction) {
          continue;
        }

        return NavigationActions.navigate({
          routeName: _routeName3,
          params: getParamsFromPath(inputParams, _extendedMatch, _extendedPathReKeys),
          action: _childAction
        });
      }
    }

    return null;
  };

  var getPathAndParamsForRoute = function getPathAndParamsForRoute(route) {
    var routeName = route.routeName,
        params = route.params;
    var childRouter = childRouters[routeName];
    var _pathsByRouteNames$ro = pathsByRouteNames[routeName],
        toPath = _pathsByRouteNames$ro.toPath,
        exactReKeys = _pathsByRouteNames$ro.exactReKeys;
    var subPath = toPath(params);
    var nonPathParams = {};

    if (params) {
      Object.keys(params).filter(function (paramName) {
        return !exactReKeys.find(function (k) {
          return k.name === paramName;
        });
      }).forEach(function (paramName) {
        nonPathParams[paramName] = params[paramName];
      });
    }

    if (childRouter) {
      var child = childRouter.getPathAndParamsForState(route);
      return {
        path: subPath ? subPath + "/" + child.path : child.path,
        params: child.params ? (0, _objectSpread2.default)({}, nonPathParams, child.params) : nonPathParams
      };
    }

    return {
      path: subPath,
      params: nonPathParams
    };
  };

  return {
    getActionForPathAndParams: getActionForPathAndParams,
    getPathAndParamsForRoute: getPathAndParamsForRoute
  };
};

exports.createPathParser = createPathParser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhdGhVdGlscy5qcyJdLCJuYW1lcyI6WyJxdWVyeVN0cmluZyIsInJlcXVpcmUiLCJnZXRQYXJhbXNGcm9tUGF0aCIsInBhcmFtcyIsInBhdGhNYXRjaCIsImtleSIsInBhdGhNYXRjaEtleXMiLCJwYXJhbU5hbWUiLCJkZWNvZGVkTWF0Y2hSZXN1bHQiLCJkZWNvZGVVUklDb21wb25lbnQiLCJwYXJhbXNPdXQiLCJnZXRSZXN0T2ZQYXRoIiwicmVzdCIsImsiLCJ1cmxUb1BhdGhBbmRQYXJhbXMiLCJzZWFyY2hNYXRjaCIsInVybCIsInVybFdpdGhvdXRTZWFyY2giLCJkZWxpbWl0ZXIiLCJ1cmlQcmVmaXgiLCJwYXRoIiwiY3JlYXRlUGF0aFBhcnNlciIsInBhdGhzIiwicGF0aENvbmZpZ3MiLCJkaXNhYmxlUm91dGVOYW1lUGF0aHMiLCJwYXRoc0J5Um91dGVOYW1lcyIsIk9iamVjdCIsInBhdGhQYXR0ZXJuIiwicm91dGVDb25maWdzIiwiaXNQYXRoTWF0Y2hhYmxlIiwiZXhhY3RSZUtleXMiLCJleGFjdFJlIiwiZXh0ZW5kZWRQYXRoUmVLZXlzIiwiaXNXaWxkY2FyZCIsImV4dGVuZGVkUGF0aFJlIiwidG9QYXRoIiwiZ2V0QWN0aW9uRm9yUGF0aEFuZFBhcmFtcyIsInBhdGhUb1Jlc29sdmUiLCJpbnB1dFBhcmFtcyIsInJvdXRlTmFtZSIsImNoaWxkUm91dGVyIiwiY2hpbGRSb3V0ZXJzIiwiZXhhY3RNYXRjaCIsImV4dGVuZGVkTWF0Y2giLCJjaGlsZEFjdGlvbiIsInJlc3RPZlBhdGgiLCJOYXZpZ2F0aW9uQWN0aW9ucyIsImFjdGlvbiIsImdldFBhdGhBbmRQYXJhbXNGb3JSb3V0ZSIsInJvdXRlIiwic3ViUGF0aCIsIm5vblBhdGhQYXJhbXMiLCJjaGlsZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUVBLElBQUEsYUFBQSxHQUFBLHVCQUFBLENBQUEsT0FBQSxDQUFBLGdCQUFBLENBQUEsQ0FBQTs7QUFDQSxJQUFBLGlCQUFBLEdB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T0FBTixHQUFBLEdBQU1BLEdBQVdFLEtBQUssQ0FBdEIsSUFBQSxHQUFnQ0EsS0FBSyxDQUQ3QyxJQUFBO0FBRUxqRCxRQUFBQSxNQUFNLEVBQUVpRCxLQUFLLENBQUxBLE1BQUFBLEdBQUFBLENBQUFBLEdBQUFBLGNBQUFBLENBQUFBLE9BQUFBLEVBQUFBLEVBQUFBLEVBQUFBLGFBQUFBLEVBQ21CQSxLQUFLLENBRHhCQSxNQUFBQSxDQUFBQSxHQUZWO0FBQU8sT0FBUDtBQU9GOztBQUFBLFdBQU87QUFDTGhDLE1BQUFBLElBQUksRUFEQyxPQUFBO0FBRUxqQixNQUFBQSxNQUFNLEVBRlI7QUFBTyxLQUFQO0FBeEJGLEdBQUE7O0FBNkJBLFNBQU87QUFBRWlDLElBQUFBLHlCQUF5QixFQUEzQix5QkFBQTtBQUE2QlksSUFBQUEsd0JBQXdCLEVBQTVEO0FBQU8sR0FBUDtBQWxKSyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgaW1wb3J0L25vLWNvbW1vbmpzICovXG5cbmltcG9ydCBwYXRoVG9SZWdleHAsIHsgY29tcGlsZSB9IGZyb20gJ3BhdGgtdG8tcmVnZXhwJztcbmltcG9ydCAqIGFzIE5hdmlnYXRpb25BY3Rpb25zIGZyb20gJy4uL05hdmlnYXRpb25BY3Rpb25zJztcbmltcG9ydCBpbnZhcmlhbnQgZnJvbSAnLi4vdXRpbHMvaW52YXJpYW50JztcblxuY29uc3QgcXVlcnlTdHJpbmcgPSByZXF1aXJlKCdxdWVyeS1zdHJpbmcnKTtcblxuZXhwb3J0IGNvbnN0IGdldFBhcmFtc0Zyb21QYXRoID0gKGlucHV0UGFyYW1zLCBwYXRoTWF0Y2gsIHBhdGhNYXRjaEtleXMpID0+IHtcbiAgY29uc3QgcGFyYW1zID0gcGF0aE1hdGNoLnNsaWNlKDEpLnJlZHVjZShcbiAgICAvLyBpdGVyYXRlIG92ZXIgbWF0Y2hlZCBwYXRoIHBhcmFtc1xuICAgIChwYXJhbXNPdXQsIG1hdGNoUmVzdWx0LCBpKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBwYXRoTWF0Y2hLZXlzW2ldO1xuICAgICAgaWYgKCFrZXkgfHwga2V5LmFzdGVyaXNrKSB7XG4gICAgICAgIHJldHVybiBwYXJhbXNPdXQ7XG4gICAgICB9XG4gICAgICBjb25zdCBwYXJhbU5hbWUgPSBrZXkubmFtZTtcblxuICAgICAgbGV0IGRlY29kZWRNYXRjaFJlc3VsdDtcbiAgICAgIGlmIChtYXRjaFJlc3VsdCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGRlY29kZWRNYXRjaFJlc3VsdCA9IGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFJlc3VsdCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAvLyBpZ25vcmUgYFVSSUVycm9yOiBtYWxmb3JtZWQgVVJJYFxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHBhcmFtc091dFtwYXJhbU5hbWVdID0gZGVjb2RlZE1hdGNoUmVzdWx0IHx8IG1hdGNoUmVzdWx0O1xuICAgICAgcmV0dXJuIHBhcmFtc091dDtcbiAgICB9LFxuICAgIHtcbiAgICAgIC8vIHN0YXJ0IHdpdGggdGhlIGlucHV0KHF1ZXJ5IHN0cmluZykgcGFyYW1zLCB3aGljaCB3aWxsIGdldCBvdmVycmlkZGVuIGJ5IHBhdGggcGFyYW1zXG4gICAgICAuLi5pbnB1dFBhcmFtcyxcbiAgICB9XG4gICk7XG4gIHJldHVybiBwYXJhbXM7XG59O1xuY29uc3QgZ2V0UmVzdE9mUGF0aCA9IChwYXRoTWF0Y2gsIHBhdGhNYXRjaEtleXMpID0+IHtcbiAgY29uc3QgcmVzdCA9IHBhdGhNYXRjaFtwYXRoTWF0Y2hLZXlzLmZpbmRJbmRleChrID0+IGsuYXN0ZXJpc2spICsgMV07XG4gIHJldHVybiByZXN0O1xufTtcblxuZXhwb3J0IGNvbnN0IHVybFRvUGF0aEFuZFBhcmFtcyA9ICh1cmwsIHVyaVByZWZpeCkgPT4ge1xuICBjb25zdCBzZWFyY2hNYXRjaCA9IHVybC5tYXRjaCgvXiguKilcXD8oLiopJC8pO1xuICBjb25zdCBwYXJhbXMgPSBzZWFyY2hNYXRjaCA/IHF1ZXJ5U3RyaW5nLnBhcnNlKHNlYXJjaE1hdGNoWzJdKSA6IHt9O1xuICBjb25zdCB1cmxXaXRob3V0U2VhcmNoID0gc2VhcmNoTWF0Y2ggPyBzZWFyY2hNYXRjaFsxXSA6IHVybDtcbiAgY29uc3QgZGVsaW1pdGVyID0gdXJpUHJlZml4IHx8ICc6Ly8nO1xuICBsZXQgcGF0aCA9IHVybFdpdGhvdXRTZWFyY2guc3BsaXQoZGVsaW1pdGVyKVsxXTtcbiAgaWYgKHBhdGggPT09IHVuZGVmaW5lZCkge1xuICAgIHBhdGggPSB1cmxXaXRob3V0U2VhcmNoO1xuICB9XG4gIGlmIChwYXRoID09PSAnLycpIHtcbiAgICBwYXRoID0gJyc7XG4gIH1cbiAgaWYgKHBhdGhbcGF0aC5sZW5ndGggLSAxXSA9PT0gJy8nKSB7XG4gICAgcGF0aCA9IHBhdGguc2xpY2UoMCwgLTEpO1xuICB9XG4gIHJldHVybiB7XG4gICAgcGF0aCxcbiAgICBwYXJhbXMsXG4gIH07XG59O1xuXG5leHBvcnQgY29uc3QgY3JlYXRlUGF0aFBhcnNlciA9IChcbiAgY2hpbGRSb3V0ZXJzLFxuICByb3V0ZUNvbmZpZ3MsXG4gIHsgcGF0aHM6IHBhdGhDb25maWdzID0ge30sIGRpc2FibGVSb3V0ZU5hbWVQYXRocyB9XG4pID0+IHtcbiAgY29uc3QgcGF0aHNCeVJvdXRlTmFtZXMgPSB7fTtcbiAgbGV0IHBhdGhzID0gW107XG5cbiAgLy8gQnVpbGQgcGF0aHNCeVJvdXRlTmFtZXMsIHdoaWNoIGluY2x1ZGVzIGEgcmVnZXggdG8gbWF0Y2ggcGF0aHMgZm9yIGVhY2ggcm91dGUuIEtlZXAgaW4gbWluZCwgdGhlIHJlZ2V4IHdpbGwgcGFzcyBmb3IgdGhlIHJvdXRlIGFuZCBhbGwgY2hpbGQgcm91dGVzLiBUaGUgY29kZSB0aGF0IHVzZXMgcGF0aHNCeVJvdXRlTmFtZXMgd2lsbCBuZWVkIHRvIGFsc28gdmVyaWZ5IHRoYXQgdGhlIGNoaWxkIHJvdXRlciBwcm9kdWNlcyBhbiBhY3Rpb24sIGluIHRoZSBjYXNlIG9mIGlzUGF0aE1hdGNoYWJsZSBmYWxzZSAoYSBudWxsIHBhdGgpLlxuICBPYmplY3Qua2V5cyhjaGlsZFJvdXRlcnMpLmZvckVhY2gocm91dGVOYW1lID0+IHtcbiAgICBsZXQgcGF0aFBhdHRlcm47XG5cbiAgICAvLyBGaXJzdCBjaGVjayBmb3IgcGF0aHMgb24gdGhlIHJvdXRlciwgdGhlbiBjaGVjayB0aGUgcm91dGUgY29uZmlnXG4gICAgaWYgKHBhdGhDb25maWdzW3JvdXRlTmFtZV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgcGF0aFBhdHRlcm4gPSBwYXRoQ29uZmlnc1tyb3V0ZU5hbWVdO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXRoUGF0dGVybiA9IHJvdXRlQ29uZmlnc1tyb3V0ZU5hbWVdLnBhdGg7XG4gICAgfVxuXG4gICAgaWYgKHBhdGhQYXR0ZXJuID09PSB1bmRlZmluZWQpIHtcbiAgICAgIC8vIElmIHRoZSB1c2VyIGhhc24ndCBzcGVjaWZpZWQgYSBwYXRoIGF0IGFsbCBub3IgZGlzYWJsZVJvdXRlTmFtZVBhdGhzLCB0aGVuIHdlIGFzc3VtZSB0aGUgcm91dGVOYW1lIGlzIGFuIGFwcHJvcHJpYXRlIHBhdGhcbiAgICAgIHBhdGhQYXR0ZXJuID0gZGlzYWJsZVJvdXRlTmFtZVBhdGhzID8gbnVsbCA6IHJvdXRlTmFtZTtcbiAgICB9XG5cbiAgICBpbnZhcmlhbnQoXG4gICAgICBwYXRoUGF0dGVybiA9PT0gbnVsbCB8fCB0eXBlb2YgcGF0aFBhdHRlcm4gPT09ICdzdHJpbmcnLFxuICAgICAgYFJvdXRlIHBhdGggZm9yICR7cm91dGVOYW1lfSBtdXN0IGJlIHNwZWNpZmllZCBhcyBhIHN0cmluZywgb3IgbnVsbC5gXG4gICAgKTtcblxuICAgIC8vIHRoZSBwYXRoIG1heSBiZSBzcGVjaWZpZWQgYXMgbnVsbCwgd2hpY2ggaXMgc2ltaWxhciB0byBlbXB0eSBzdHJpbmcgYmVjYXVzZSBpdCBhbGxvd3MgY2hpbGQgcm91dGVycyB0byBoYW5kbGUgdGhlIGFjdGlvbiwgYnV0IGl0IHdpbGwgbm90IG1hdGNoIGVtcHR5IHBhdGhzXG4gICAgY29uc3QgaXNQYXRoTWF0Y2hhYmxlID0gcGF0aFBhdHRlcm4gIT09IG51bGw7XG4gICAgLy8gcGF0aFBhdHRlcm4gaXMgYSBzdHJpbmcgd2l0aCBpbmxpbmUgcGFyYW1zLCBzdWNoIGFzIHBlb3BsZS86aWQvKmZvb1xuICAgIGNvbnN0IGV4YWN0UmVLZXlzID0gW107XG4gICAgY29uc3QgZXhhY3RSZSA9IGlzUGF0aE1hdGNoYWJsZVxuICAgICAgPyBwYXRoVG9SZWdleHAocGF0aFBhdHRlcm4sIGV4YWN0UmVLZXlzKVxuICAgICAgOiBudWxsO1xuICAgIGNvbnN0IGV4dGVuZGVkUGF0aFJlS2V5cyA9IFtdO1xuICAgIGNvbnN0IGlzV2lsZGNhcmQgPSBwYXRoUGF0dGVybiA9PT0gJycgfHwgIWlzUGF0aE1hdGNoYWJsZTtcbiAgICBjb25zdCBleHRlbmRlZFBhdGhSZSA9IHBhdGhUb1JlZ2V4cChcbiAgICAgIGlzV2lsZGNhcmQgPyAnKicgOiBgJHtwYXRoUGF0dGVybn0vKmAsXG4gICAgICBleHRlbmRlZFBhdGhSZUtleXNcbiAgICApO1xuXG4gICAgcGF0aHNCeVJvdXRlTmFtZXNbcm91dGVOYW1lXSA9IHtcbiAgICAgIGV4YWN0UmUsXG4gICAgICBleGFjdFJlS2V5cyxcbiAgICAgIGV4dGVuZGVkUGF0aFJlLFxuICAgICAgZXh0ZW5kZWRQYXRoUmVLZXlzLFxuICAgICAgaXNXaWxkY2FyZCxcbiAgICAgIHRvUGF0aDogcGF0aFBhdHRlcm4gPT09IG51bGwgPyAoKSA9PiAnJyA6IGNvbXBpbGUocGF0aFBhdHRlcm4pLFxuICAgIH07XG4gIH0pO1xuXG4gIHBhdGhzID0gT2JqZWN0LmVudHJpZXMocGF0aHNCeVJvdXRlTmFtZXMpO1xuXG4gIGNvbnN0IGdldEFjdGlvbkZvclBhdGhBbmRQYXJhbXMgPSAocGF0aFRvUmVzb2x2ZSA9ICcnLCBpbnB1dFBhcmFtcyA9IHt9KSA9PiB7XG4gICAgLy8gQXR0ZW1wdCB0byBtYXRjaCBgcGF0aFRvUmVzb2x2ZWAgd2l0aCBhIHJvdXRlIGluIHRoaXMgcm91dGVyJ3Mgcm91dGVDb25maWdzLCBkZWZlcnJpbmcgdG8gY2hpbGQgcm91dGVyc1xuXG4gICAgZm9yIChjb25zdCBbcm91dGVOYW1lLCBwYXRoXSBvZiBwYXRocykge1xuICAgICAgY29uc3QgeyBleGFjdFJlLCBleGFjdFJlS2V5cywgZXh0ZW5kZWRQYXRoUmUsIGV4dGVuZGVkUGF0aFJlS2V5cyB9ID0gcGF0aDtcbiAgICAgIGNvbnN0IGNoaWxkUm91dGVyID0gY2hpbGRSb3V0ZXJzW3JvdXRlTmFtZV07XG5cbiAgICAgIGNvbnN0IGV4YWN0TWF0Y2ggPSBleGFjdFJlICYmIGV4YWN0UmUuZXhlYyhwYXRoVG9SZXNvbHZlKTtcblxuICAgICAgaWYgKGV4YWN0TWF0Y2ggJiYgZXhhY3RNYXRjaC5sZW5ndGgpIHtcbiAgICAgICAgY29uc3QgZXh0ZW5kZWRNYXRjaCA9XG4gICAgICAgICAgZXh0ZW5kZWRQYXRoUmUgJiYgZXh0ZW5kZWRQYXRoUmUuZXhlYyhwYXRoVG9SZXNvbHZlKTtcbiAgICAgICAgbGV0IGNoaWxkQWN0aW9uID0gbnVsbDtcbiAgICAgICAgaWYgKGV4dGVuZGVkTWF0Y2ggJiYgY2hpbGRSb3V0ZXIpIHtcbiAgICAgICAgICBjb25zdCByZXN0T2ZQYXRoID0gZ2V0UmVzdE9mUGF0aChleHRlbmRlZE1hdGNoLCBleHRlbmRlZFBhdGhSZUtleXMpO1xuICAgICAgICAgIGNoaWxkQWN0aW9uID0gY2hpbGRSb3V0ZXIuZ2V0QWN0aW9uRm9yUGF0aEFuZFBhcmFtcyhcbiAgICAgICAgICAgIHJlc3RPZlBhdGgsXG4gICAgICAgICAgICBpbnB1dFBhcmFtc1xuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gTmF2aWdhdGlvbkFjdGlvbnMubmF2aWdhdGUoe1xuICAgICAgICAgIHJvdXRlTmFtZSxcbiAgICAgICAgICBwYXJhbXM6IGdldFBhcmFtc0Zyb21QYXRoKGlucHV0UGFyYW1zLCBleGFjdE1hdGNoLCBleGFjdFJlS2V5cyksXG4gICAgICAgICAgYWN0aW9uOiBjaGlsZEFjdGlvbixcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBbcm91dGVOYW1lLCBwYXRoXSBvZiBwYXRocykge1xuICAgICAgY29uc3QgeyBleHRlbmRlZFBhdGhSZSwgZXh0ZW5kZWRQYXRoUmVLZXlzIH0gPSBwYXRoO1xuICAgICAgY29uc3QgY2hpbGRSb3V0ZXIgPSBjaGlsZFJvdXRlcnNbcm91dGVOYW1lXTtcblxuICAgICAgY29uc3QgZXh0ZW5kZWRNYXRjaCA9XG4gICAgICAgIGV4dGVuZGVkUGF0aFJlICYmIGV4dGVuZGVkUGF0aFJlLmV4ZWMocGF0aFRvUmVzb2x2ZSk7XG5cbiAgICAgIGlmIChleHRlbmRlZE1hdGNoICYmIGV4dGVuZGVkTWF0Y2gubGVuZ3RoKSB7XG4gICAgICAgIGNvbnN0IHJlc3RPZlBhdGggPSBnZXRSZXN0T2ZQYXRoKGV4dGVuZGVkTWF0Y2gsIGV4dGVuZGVkUGF0aFJlS2V5cyk7XG4gICAgICAgIGxldCBjaGlsZEFjdGlvbiA9IG51bGw7XG4gICAgICAgIGlmIChjaGlsZFJvdXRlcikge1xuICAgICAgICAgIGNoaWxkQWN0aW9uID0gY2hpbGRSb3V0ZXIuZ2V0QWN0aW9uRm9yUGF0aEFuZFBhcmFtcyhcbiAgICAgICAgICAgIHJlc3RPZlBhdGgsXG4gICAgICAgICAgICBpbnB1dFBhcmFtc1xuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjaGlsZEFjdGlvbikge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBOYXZpZ2F0aW9uQWN0aW9ucy5uYXZpZ2F0ZSh7XG4gICAgICAgICAgcm91dGVOYW1lLFxuICAgICAgICAgIHBhcmFtczogZ2V0UGFyYW1zRnJvbVBhdGgoXG4gICAgICAgICAgICBpbnB1dFBhcmFtcyxcbiAgICAgICAgICAgIGV4dGVuZGVkTWF0Y2gsXG4gICAgICAgICAgICBleHRlbmRlZFBhdGhSZUtleXNcbiAgICAgICAgICApLFxuICAgICAgICAgIGFjdGlvbjogY2hpbGRBY3Rpb24sXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9O1xuICBjb25zdCBnZXRQYXRoQW5kUGFyYW1zRm9yUm91dGUgPSByb3V0ZSA9PiB7XG4gICAgY29uc3QgeyByb3V0ZU5hbWUsIHBhcmFtcyB9ID0gcm91dGU7XG4gICAgY29uc3QgY2hpbGRSb3V0ZXIgPSBjaGlsZFJvdXRlcnNbcm91dGVOYW1lXTtcbiAgICBjb25zdCB7IHRvUGF0aCwgZXhhY3RSZUtleXMgfSA9IHBhdGhzQnlSb3V0ZU5hbWVzW3JvdXRlTmFtZV07XG4gICAgY29uc3Qgc3ViUGF0aCA9IHRvUGF0aChwYXJhbXMpO1xuICAgIGNvbnN0IG5vblBhdGhQYXJhbXMgPSB7fTtcbiAgICBpZiAocGFyYW1zKSB7XG4gICAgICBPYmplY3Qua2V5cyhwYXJhbXMpXG4gICAgICAgIC5maWx0ZXIocGFyYW1OYW1lID0+ICFleGFjdFJlS2V5cy5maW5kKGsgPT4gay5uYW1lID09PSBwYXJhbU5hbWUpKVxuICAgICAgICAuZm9yRWFjaChwYXJhbU5hbWUgPT4ge1xuICAgICAgICAgIG5vblBhdGhQYXJhbXNbcGFyYW1OYW1lXSA9IHBhcmFtc1twYXJhbU5hbWVdO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgaWYgKGNoaWxkUm91dGVyKSB7XG4gICAgICAvLyBJZiBpdCBoYXMgYSByb3V0ZXIgaXQncyBhIG5hdmlnYXRvci5cbiAgICAgIC8vIElmIGl0IGRvZXNuJ3QgaGF2ZSByb3V0ZXIgaXQncyBhbiBvcmRpbmFyeSBSZWFjdCBjb21wb25lbnQuXG4gICAgICBjb25zdCBjaGlsZCA9IGNoaWxkUm91dGVyLmdldFBhdGhBbmRQYXJhbXNGb3JTdGF0ZShyb3V0ZSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwYXRoOiBzdWJQYXRoID8gYCR7c3ViUGF0aH0vJHtjaGlsZC5wYXRofWAgOiBjaGlsZC5wYXRoLFxuICAgICAgICBwYXJhbXM6IGNoaWxkLnBhcmFtc1xuICAgICAgICAgID8geyAuLi5ub25QYXRoUGFyYW1zLCAuLi5jaGlsZC5wYXJhbXMgfVxuICAgICAgICAgIDogbm9uUGF0aFBhcmFtcyxcbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBwYXRoOiBzdWJQYXRoLFxuICAgICAgcGFyYW1zOiBub25QYXRoUGFyYW1zLFxuICAgIH07XG4gIH07XG4gIHJldHVybiB7IGdldEFjdGlvbkZvclBhdGhBbmRQYXJhbXMsIGdldFBhdGhBbmRQYXJhbXNGb3JSb3V0ZSB9O1xufTtcbiJdfQ==