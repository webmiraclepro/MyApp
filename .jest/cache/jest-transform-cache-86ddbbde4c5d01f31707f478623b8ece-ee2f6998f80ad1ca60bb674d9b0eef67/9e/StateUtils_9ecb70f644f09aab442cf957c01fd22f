cec5954d69c22b8287e6c0f7cb696a9c
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _invariant = _interopRequireDefault(require("./utils/invariant"));

var StateUtils = {
  get: function get(state, key) {
    return state.routes.find(function (route) {
      return route.key === key;
    }) || null;
  },
  indexOf: function indexOf(state, key) {
    return state.routes.findIndex(function (route) {
      return route.key === key;
    });
  },
  has: function has(state, key) {
    return !!state.routes.some(function (route) {
      return route.key === key;
    });
  },
  push: function push(state, route) {
    (0, _invariant.default)(StateUtils.indexOf(state, route.key) === -1, 'should not push route with duplicated key %s', route.key);
    var routes = state.routes.slice();
    routes.push(route);
    return (0, _objectSpread2.default)({}, state, {
      index: routes.length - 1,
      routes: routes
    });
  },
  pop: function pop(state) {
    if (state.index <= 0) {
      return state;
    }

    var routes = state.routes.slice(0, -1);
    return (0, _objectSpread2.default)({}, state, {
      index: routes.length - 1,
      routes: routes
    });
  },
  jumpToIndex: function jumpToIndex(state, index) {
    if (index === state.index) {
      return state;
    }

    (0, _invariant.default)(!!state.routes[index], 'invalid index %s to jump to', index);
    return (0, _objectSpread2.default)({}, state, {
      index: index
    });
  },
  jumpTo: function jumpTo(state, key) {
    var index = StateUtils.indexOf(state, key);
    return StateUtils.jumpToIndex(state, index);
  },
  back: function back(state) {
    var index = state.index - 1;
    var route = state.routes[index];
    return route ? StateUtils.jumpToIndex(state, index) : state;
  },
  forward: function forward(state) {
    var index = state.index + 1;
    var route = state.routes[index];
    return route ? StateUtils.jumpToIndex(state, index) : state;
  },
  replaceAndPrune: function replaceAndPrune(state, key, route) {
    var index = StateUtils.indexOf(state, key);
    var replaced = StateUtils.replaceAtIndex(state, index, route);
    return (0, _objectSpread2.default)({}, replaced, {
      routes: replaced.routes.slice(0, index + 1)
    });
  },
  replaceAt: function replaceAt(state, key, route) {
    var preserveIndex = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
    var index = StateUtils.indexOf(state, key);
    var nextIndex = preserveIndex ? state.index : index;
    var nextState = StateUtils.replaceAtIndex(state, index, route);
    nextState.index = nextIndex;
    return nextState;
  },
  replaceAtIndex: function replaceAtIndex(state, index, route) {
    (0, _invariant.default)(!!state.routes[index], 'invalid index %s for replacing route %s', index, route.key);

    if (state.routes[index] === route && index === state.index) {
      return state;
    }

    var routes = state.routes.slice();
    routes[index] = route;
    return (0, _objectSpread2.default)({}, state, {
      index: index,
      routes: routes
    });
  },
  reset: function reset(state, routes, index) {
    (0, _invariant.default)(routes.length && Array.isArray(routes), 'invalid routes to replace');
    var nextIndex = index === undefined ? routes.length - 1 : index;

    if (state.routes.length === routes.length && state.index === nextIndex) {
      var compare = function compare(route, ii) {
        return routes[ii] === route;
      };

      if (state.routes.every(compare)) {
        return state;
      }
    }

    (0, _invariant.default)(!!routes[nextIndex], 'invalid index %s to reset', nextIndex);
    return (0, _objectSpread2.default)({}, state, {
      index: nextIndex,
      routes: routes
    });
  }
};
var _default = StateUtils;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlN0YXRlVXRpbHMuanMiXSwibmFtZXMiOlsiU3RhdGVVdGlscyIsImdldCIsInN0YXRlIiwicm91dGUiLCJpbmRleE9mIiwiaGFzIiwicHVzaCIsInJvdXRlcyIsImluZGV4IiwicG9wIiwianVtcFRvSW5kZXgiLCJqdW1wVG8iLCJiYWNrIiwiZm9yd2FyZCIsInJlcGxhY2VBbmRQcnVuZSIsInJlcGxhY2VkIiwicmVwbGFjZUF0IiwicHJlc2VydmVJbmRleCIsIm5leHRJbmRleCIsIm5leHRTdGF0ZSIsInJlcGxhY2VBdEluZGV4IiwicmVzZXQiLCJBcnJheSIsImNvbXBhcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLElBQUEsVUFBQSxHQUFBLHNCQUFBLENBQUEsT0FBQSxDQUFBLG1CQUFBLENBQUEsQ0FBQTs7QUFVQSxJQUFNQSxVQUFVLEdBQUc7QUFJakJDLEVBQUFBLEdBSmlCLEVBQUEsU0FBQSxHQUFBLENBQUEsS0FBQSxFQUFBLEdBQUEsRUFJRDtBQUNkLFdBQU9DLEtBQUssQ0FBTEEsTUFBQUEsQ0FBQUEsSUFBQUEsQ0FBa0IsVUFBQSxLQUFBLEVBQUs7QUFBQSxhQUFJQyxLQUFLLENBQUxBLEdBQUFBLEtBQUosR0FBQTtBQUF2QkQsS0FBQUEsS0FBUCxJQUFBO0FBTGUsR0FBQTtBQVlqQkUsRUFBQUEsT0FaaUIsRUFBQSxTQUFBLE9BQUEsQ0FBQSxLQUFBLEVBQUEsR0FBQSxFQVlHO0FBQ2xCLFdBQU9GLEtBQUssQ0FBTEEsTUFBQUEsQ0FBQUEsU0FBQUEsQ0FBdUIsVUFBQSxLQUFBLEVBQUs7QUFBQSxhQUFJQyxLQUFLLENBQUxBLEdBQUFBLEtBQUosR0FBQTtBQUFuQyxLQUFPRCxDQUFQO0FBYmUsR0FBQTtBQW9CakJHLEVBQUFBLEdBcEJpQixFQUFBLFNBQUEsR0FBQSxDQUFBLEtBQUEsRUFBQSxHQUFBLEVBb0JEO0FBQ2QsV0FBTyxDQUFDLENBQUNILEtBQUssQ0FBTEEsTUFBQUEsQ0FBQUEsSUFBQUEsQ0FBa0IsVUFBQSxLQUFB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RUEsUUFBSU4sS0FBSyxDQUFMQSxNQUFBQSxDQUFBQSxNQUFBQSxLQUF3QkssTUFBTSxDQUE5QkwsTUFBQUEsSUFBeUNBLEtBQUssQ0FBTEEsS0FBQUEsS0FBN0MsU0FBQSxFQUF3RTtBQUN0RSxVQUFNcUIsT0FBTyxHQUFQQSxTQUFBQSxPQUFBQSxDQUFVLEtBQVZBLEVBQVUsRUFBVkEsRUFBVTtBQUFBLGVBQWVoQixNQUFNLENBQU5BLEVBQU0sQ0FBTkEsS0FBZixLQUFBO0FBQWhCLE9BQUE7O0FBQ0EsVUFBSUwsS0FBSyxDQUFMQSxNQUFBQSxDQUFBQSxLQUFBQSxDQUFKLE9BQUlBLENBQUosRUFBaUM7QUFDL0IsZUFBQSxLQUFBO0FBRUg7QUFFRDs7QUFBQSxLQUFBLEdBQUEsVUFBQSxDQUFBLE9BQUEsRUFBVSxDQUFDLENBQUNLLE1BQU0sQ0FBbEIsU0FBa0IsQ0FBbEIsRUFBQSwyQkFBQSxFQUFBLFNBQUE7QUFFQSxXQUFBLENBQUEsR0FBQSxjQUFBLENBQUEsT0FBQSxFQUFBLEVBQUEsRUFBQSxLQUFBLEVBQUE7QUFFRUMsTUFBQUEsS0FBSyxFQUZQLFNBQUE7QUFHRUQsTUFBQUEsTUFBTSxFQUhSO0FBQUEsS0FBQSxDQUFBO0FBekxKO0FBQW1CLENBQW5CO2VBaU1lUCxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGludmFyaWFudCBmcm9tICcuL3V0aWxzL2ludmFyaWFudCc7XG5cbi8qKlxuICogVXRpbGl0aWVzIHRvIHBlcmZvcm0gYXRvbWljIG9wZXJhdGlvbiB3aXRoIG5hdmlnYXRlIHN0YXRlIGFuZCByb3V0ZXMuXG4gKlxuICogYGBgamF2YXNjcmlwdFxuICogY29uc3Qgc3RhdGUxID0ge2tleTogJ3NjcmVlbiAxJ307XG4gKiBjb25zdCBzdGF0ZTIgPSBOYXZpZ2F0aW9uU3RhdGVVdGlscy5wdXNoKHN0YXRlMSwge2tleTogJ3NjcmVlbiAyJ30pO1xuICogYGBgXG4gKi9cbmNvbnN0IFN0YXRlVXRpbHMgPSB7XG4gIC8qKlxuICAgKiBHZXRzIGEgcm91dGUgYnkga2V5LiBJZiB0aGUgcm91dGUgaXNuJ3QgZm91bmQsIHJldHVybnMgYG51bGxgLlxuICAgKi9cbiAgZ2V0KHN0YXRlLCBrZXkpIHtcbiAgICByZXR1cm4gc3RhdGUucm91dGVzLmZpbmQocm91dGUgPT4gcm91dGUua2V5ID09PSBrZXkpIHx8IG51bGw7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGZpcnN0IGluZGV4IGF0IHdoaWNoIGEgZ2l2ZW4gcm91dGUncyBrZXkgY2FuIGJlIGZvdW5kIGluIHRoZVxuICAgKiByb3V0ZXMgb2YgdGhlIG5hdmlnYXRpb24gc3RhdGUsIG9yIC0xIGlmIGl0IGlzIG5vdCBwcmVzZW50LlxuICAgKi9cbiAgaW5kZXhPZihzdGF0ZSwga2V5KSB7XG4gICAgcmV0dXJuIHN0YXRlLnJvdXRlcy5maW5kSW5kZXgocm91dGUgPT4gcm91dGUua2V5ID09PSBrZXkpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGB0cnVlYCBhdCB3aGljaCBhIGdpdmVuIHJvdXRlJ3Mga2V5IGNhbiBiZSBmb3VuZCBpbiB0aGVcbiAgICogcm91dGVzIG9mIHRoZSBuYXZpZ2F0aW9uIHN0YXRlLlxuICAgKi9cbiAgaGFzKHN0YXRlLCBrZXkpIHtcbiAgICByZXR1cm4gISFzdGF0ZS5yb3V0ZXMuc29tZShyb3V0ZSA9PiByb3V0ZS5rZXkgPT09IGtleSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFB1c2hlcyBhIG5ldyByb3V0ZSBpbnRvIHRoZSBuYXZpZ2F0aW9uIHN0YXRlLlxuICAgKiBOb3RlIHRoYXQgdGhpcyBtb3ZlcyB0aGUgaW5kZXggdG8gdGhlIHBvc2l0aW9uIHRvIHdoZXJlIHRoZSBsYXN0IHJvdXRlIGluIHRoZVxuICAgKiBzdGFjayBpcyBhdC5cbiAgICovXG4gIHB1c2goc3RhdGUsIHJvdXRlKSB7XG4gICAgaW52YXJpYW50KFxuICAgICAgU3RhdGVVdGlscy5pbmRleE9mKHN0YXRlLCByb3V0ZS5rZXkpID09PSAtMSxcbiAgICAgICdzaG91bGQgbm90IHB1c2ggcm91dGUgd2l0aCBkdXBsaWNhdGVkIGtleSAlcycsXG4gICAgICByb3V0ZS5rZXlcbiAgICApO1xuXG4gICAgY29uc3Qgcm91dGVzID0gc3RhdGUucm91dGVzLnNsaWNlKCk7XG4gICAgcm91dGVzLnB1c2gocm91dGUpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgaW5kZXg6IHJvdXRlcy5sZW5ndGggLSAxLFxuICAgICAgcm91dGVzLFxuICAgIH07XG4gIH0sXG5cbiAgLyoqXG4gICAqIFBvcHMgb3V0IGEgcm91dGUgZnJvbSB0aGUgbmF2aWdhdGlvbiBzdGF0ZS5cbiAgICogTm90ZSB0aGF0IHRoaXMgbW92ZXMgdGhlIGluZGV4IHRvIHRoZSBwb3NpdGlvbiB0byB3aGVyZSB0aGUgbGFzdCByb3V0ZSBpbiB0aGVcbiAgICogc3RhY2sgaXMgYXQuXG4gICAqL1xuICBwb3Aoc3RhdGUpIHtcbiAgICBpZiAoc3RhdGUuaW5kZXggPD0gMCkge1xuICAgICAgLy8gW05vdGVdOiBPdmVyLXBvcHBpbmcgZG9lcyBub3QgdGhyb3cgZXJyb3IuIEluc3RlYWQsIGl0IHdpbGwgYmUgbm8tb3AuXG4gICAgICByZXR1cm4gc3RhdGU7XG4gICAgfVxuICAgIGNvbnN0IHJvdXRlcyA9IHN0YXRlLnJvdXRlcy5zbGljZSgwLCAtMSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgaW5kZXg6IHJvdXRlcy5sZW5ndGggLSAxLFxuICAgICAgcm91dGVzLFxuICAgIH07XG4gIH0sXG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIGZvY3VzZWQgcm91dGUgb2YgdGhlIG5hdmlnYXRpb24gc3RhdGUgYnkgaW5kZXguXG4gICAqL1xuICBqdW1wVG9JbmRleChzdGF0ZSwgaW5kZXgpIHtcbiAgICBpZiAoaW5kZXggPT09IHN0YXRlLmluZGV4KSB7XG4gICAgICByZXR1cm4gc3RhdGU7XG4gICAgfVxuXG4gICAgaW52YXJpYW50KCEhc3RhdGUucm91dGVzW2luZGV4XSwgJ2ludmFsaWQgaW5kZXggJXMgdG8ganVtcCB0bycsIGluZGV4KTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGluZGV4LFxuICAgIH07XG4gIH0sXG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIGZvY3VzZWQgcm91dGUgb2YgdGhlIG5hdmlnYXRpb24gc3RhdGUgYnkga2V5LlxuICAgKi9cbiAganVtcFRvKHN0YXRlLCBrZXkpIHtcbiAgICBjb25zdCBpbmRleCA9IFN0YXRlVXRpbHMuaW5kZXhPZihzdGF0ZSwga2V5KTtcbiAgICByZXR1cm4gU3RhdGVVdGlscy5qdW1wVG9JbmRleChzdGF0ZSwgaW5kZXgpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBmb2N1c2VkIHJvdXRlIHRvIHRoZSBwcmV2aW91cyByb3V0ZS5cbiAgICovXG4gIGJhY2soc3RhdGUpIHtcbiAgICBjb25zdCBpbmRleCA9IHN0YXRlLmluZGV4IC0gMTtcbiAgICBjb25zdCByb3V0ZSA9IHN0YXRlLnJvdXRlc1tpbmRleF07XG4gICAgcmV0dXJuIHJvdXRlID8gU3RhdGVVdGlscy5qdW1wVG9JbmRleChzdGF0ZSwgaW5kZXgpIDogc3RhdGU7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIGZvY3VzZWQgcm91dGUgdG8gdGhlIG5leHQgcm91dGUuXG4gICAqL1xuICBmb3J3YXJkKHN0YXRlKSB7XG4gICAgY29uc3QgaW5kZXggPSBzdGF0ZS5pbmRleCArIDE7XG4gICAgY29uc3Qgcm91dGUgPSBzdGF0ZS5yb3V0ZXNbaW5kZXhdO1xuICAgIHJldHVybiByb3V0ZSA/IFN0YXRlVXRpbHMuanVtcFRvSW5kZXgoc3RhdGUsIGluZGV4KSA6IHN0YXRlO1xuICB9LFxuXG4gIC8qKlxuICAgKiBSZXBsYWNlIGEgcm91dGUgYnkgYSBrZXkuXG4gICAqIE5vdGUgdGhhdCB0aGlzIG1vdmVzIHRoZSBpbmRleCB0byB0aGUgcG9zaXRpb24gdG8gd2hlcmUgdGhlIG5ldyByb3V0ZSBpbiB0aGVcbiAgICogc3RhY2sgaXMgYXQgYW5kIHVwZGF0ZXMgdGhlIHJvdXRlcyBhcnJheSBhY2NvcmRpbmdseS5cbiAgICovXG4gIHJlcGxhY2VBbmRQcnVuZShzdGF0ZSwga2V5LCByb3V0ZSkge1xuICAgIGNvbnN0IGluZGV4ID0gU3RhdGVVdGlscy5pbmRleE9mKHN0YXRlLCBrZXkpO1xuICAgIGNvbnN0IHJlcGxhY2VkID0gU3RhdGVVdGlscy5yZXBsYWNlQXRJbmRleChzdGF0ZSwgaW5kZXgsIHJvdXRlKTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi5yZXBsYWNlZCxcbiAgICAgIHJvdXRlczogcmVwbGFjZWQucm91dGVzLnNsaWNlKDAsIGluZGV4ICsgMSksXG4gICAgfTtcbiAgfSxcblxuICAvKipcbiAgICogUmVwbGFjZSBhIHJvdXRlIGJ5IGEga2V5LlxuICAgKiBOb3RlIHRoYXQgdGhpcyBtb3ZlcyB0aGUgaW5kZXggdG8gdGhlIHBvc2l0aW9uIHRvIHdoZXJlIHRoZSBuZXcgcm91dGUgaW4gdGhlXG4gICAqIHN0YWNrIGlzIGF0LiBEb2VzIG5vdCBwcnVuZSB0aGUgcm91dGVzLlxuICAgKiBJZiBwcmVzZXJ2ZUluZGV4IGlzIHRydWUgdGhlbiByZXBsYWNpbmcgdGhlIHJvdXRlIGRvZXMgbm90IGNhdXNlIHRoZSBpbmRleFxuICAgKiB0byBjaGFuZ2UgdG8gdGhlIGluZGV4IG9mIHRoYXQgcm91dGUuXG4gICAqL1xuICByZXBsYWNlQXQoc3RhdGUsIGtleSwgcm91dGUsIHByZXNlcnZlSW5kZXggPSBmYWxzZSkge1xuICAgIGNvbnN0IGluZGV4ID0gU3RhdGVVdGlscy5pbmRleE9mKHN0YXRlLCBrZXkpO1xuICAgIGNvbnN0IG5leHRJbmRleCA9IHByZXNlcnZlSW5kZXggPyBzdGF0ZS5pbmRleCA6IGluZGV4O1xuICAgIGxldCBuZXh0U3RhdGUgPSBTdGF0ZVV0aWxzLnJlcGxhY2VBdEluZGV4KHN0YXRlLCBpbmRleCwgcm91dGUpO1xuICAgIG5leHRTdGF0ZS5pbmRleCA9IG5leHRJbmRleDtcbiAgICByZXR1cm4gbmV4dFN0YXRlO1xuICB9LFxuXG4gIC8qKlxuICAgKiBSZXBsYWNlIGEgcm91dGUgYnkgYSBpbmRleC5cbiAgICogTm90ZSB0aGF0IHRoaXMgbW92ZXMgdGhlIGluZGV4IHRvIHRoZSBwb3NpdGlvbiB0byB3aGVyZSB0aGUgbmV3IHJvdXRlIGluIHRoZVxuICAgKiBzdGFjayBpcyBhdC5cbiAgICovXG4gIHJlcGxhY2VBdEluZGV4KHN0YXRlLCBpbmRleCwgcm91dGUpIHtcbiAgICBpbnZhcmlhbnQoXG4gICAgICAhIXN0YXRlLnJvdXRlc1tpbmRleF0sXG4gICAgICAnaW52YWxpZCBpbmRleCAlcyBmb3IgcmVwbGFjaW5nIHJvdXRlICVzJyxcbiAgICAgIGluZGV4LFxuICAgICAgcm91dGUua2V5XG4gICAgKTtcblxuICAgIGlmIChzdGF0ZS5yb3V0ZXNbaW5kZXhdID09PSByb3V0ZSAmJiBpbmRleCA9PT0gc3RhdGUuaW5kZXgpIHtcbiAgICAgIHJldHVybiBzdGF0ZTtcbiAgICB9XG5cbiAgICBjb25zdCByb3V0ZXMgPSBzdGF0ZS5yb3V0ZXMuc2xpY2UoKTtcbiAgICByb3V0ZXNbaW5kZXhdID0gcm91dGU7XG5cbiAgICByZXR1cm4ge1xuICAgICAgLi4uc3RhdGUsXG4gICAgICBpbmRleCxcbiAgICAgIHJvdXRlcyxcbiAgICB9O1xuICB9LFxuXG4gIC8qKlxuICAgKiBSZXNldHMgYWxsIHJvdXRlcy5cbiAgICogTm90ZSB0aGF0IHRoaXMgbW92ZXMgdGhlIGluZGV4IHRvIHRoZSBwb3NpdGlvbiB0byB3aGVyZSB0aGUgbGFzdCByb3V0ZSBpbiB0aGVcbiAgICogc3RhY2sgaXMgYXQgaWYgdGhlIHBhcmFtIGBpbmRleGAgaXNuJ3QgcHJvdmlkZWQuXG4gICAqL1xuICByZXNldChzdGF0ZSwgcm91dGVzLCBpbmRleCkge1xuICAgIGludmFyaWFudChcbiAgICAgIHJvdXRlcy5sZW5ndGggJiYgQXJyYXkuaXNBcnJheShyb3V0ZXMpLFxuICAgICAgJ2ludmFsaWQgcm91dGVzIHRvIHJlcGxhY2UnXG4gICAgKTtcblxuICAgIGNvbnN0IG5leHRJbmRleCA9IGluZGV4ID09PSB1bmRlZmluZWQgPyByb3V0ZXMubGVuZ3RoIC0gMSA6IGluZGV4O1xuXG4gICAgaWYgKHN0YXRlLnJvdXRlcy5sZW5ndGggPT09IHJvdXRlcy5sZW5ndGggJiYgc3RhdGUuaW5kZXggPT09IG5leHRJbmRleCkge1xuICAgICAgY29uc3QgY29tcGFyZSA9IChyb3V0ZSwgaWkpID0+IHJvdXRlc1tpaV0gPT09IHJvdXRlO1xuICAgICAgaWYgKHN0YXRlLnJvdXRlcy5ldmVyeShjb21wYXJlKSkge1xuICAgICAgICByZXR1cm4gc3RhdGU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaW52YXJpYW50KCEhcm91dGVzW25leHRJbmRleF0sICdpbnZhbGlkIGluZGV4ICVzIHRvIHJlc2V0JywgbmV4dEluZGV4KTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGluZGV4OiBuZXh0SW5kZXgsXG4gICAgICByb3V0ZXMsXG4gICAgfTtcbiAgfSxcbn07XG5cbmV4cG9ydCBkZWZhdWx0IFN0YXRlVXRpbHM7XG4iXX0=