cf404380f139cf5ed9fda779fa022bad
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = ScenesReducer;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _shallowEqual = _interopRequireDefault(require("../utils/shallowEqual"));

var SCENE_KEY_PREFIX = 'scene_';

function compareKey(one, two) {
  var delta = one.length - two.length;

  if (delta > 0) {
    return 1;
  }

  if (delta < 0) {
    return -1;
  }

  return one > two ? 1 : -1;
}

function compareScenes(one, two) {
  if (one.index > two.index) {
    return 1;
  }

  if (one.index < two.index) {
    return -1;
  }

  return compareKey(one.key, two.key);
}

function areScenesShallowEqual(one, two) {
  return one.key === two.key && one.index === two.index && one.isStale === two.isStale && one.isActive === two.isActive && areRoutesShallowEqual(one.route, two.route);
}

function areRoutesShallowEqual(one, two) {
  if (!one || !two) {
    return one === two;
  }

  if (one.key !== two.key) {
    return false;
  }

  return (0, _shallowEqual.default)(one, two);
}

function ScenesReducer(scenes, nextState, prevState, descriptors) {
  scenes.forEach(function (scene) {
    var route = scene.route;

    if (descriptors && descriptors[route.key]) {
      scene.descriptor = descriptors[route.key];
    }
  });

  if (prevState === nextState) {
    return scenes;
  }

  var prevScenes = new Map();
  var freshScenes = new Map();
  var staleScenes = new Map();
  scenes.forEach(function (scene) {
    var key = scene.key;

    if (scene.isStale) {
      staleScenes.set(key, scene);
    }

    prevScenes.set(key, scene);
  });
  var nextKeys = new Set();
  var nextRoutes = nextState.routes;

  if (nextRoutes.length > nextState.index + 1) {
    console.warn('StackRouter provided invalid state, index should always be the top route');
    nextRoutes = nextState.routes.slice(0, nextState.index + 1);
  }

  nextRoutes.forEach(function (route, index) {
    var key = SCENE_KEY_PREFIX + route.key;
    var descriptor = descriptors && descriptors[route.key];
    var scene = {
      index: index,
      isActive: false,
      isStale: false,
      key: key,
      route: route,
      descriptor: descriptor
    };

    if (nextKeys.has(key)) {
      throw new Error("navigation.state.routes[" + index + "].key \"" + key + "\" conflicts with " + 'another route!');
    }

    nextKeys.add(key);

    if (staleScenes.has(key)) {
      staleScenes.delete(key);
    }

    freshScenes.set(key, scene);
  });

  if (prevState) {
    var prevRoutes = prevState.routes;

    if (prevRoutes.length > prevState.index + 1) {
      console.warn('StackRouter provided invalid state, index should always be the top route');
      prevRoutes = prevRoutes.slice(0, prevState.index + 1);
    }

    prevRoutes.forEach(function (route, index) {
      var key = SCENE_KEY_PREFIX + route.key;

      if (freshScenes.has(key)) {
        return;
      }

      var lastScene = scenes.find(function (scene) {
        return scene.route.key === route.key;
      });
      var descriptor = lastScene ? lastScene.descriptor : descriptors[route.key];

      if (descriptor) {
        staleScenes.set(key, {
          index: index,
          isActive: false,
          isStale: true,
          key: key,
          route: route,
          descriptor: descriptor
        });
      }
    });
  }

  var nextScenes = [];

  var mergeScene = function mergeScene(nextScene) {
    var key = nextScene.key;
    var prevScene = prevScenes.has(key) ? prevScenes.get(key) : null;

    if (prevScene && areScenesShallowEqual(prevScene, nextScene)) {
      nextScenes.push(prevScene);
    } else {
      nextScenes.push(nextScene);
    }
  };

  staleScenes.forEach(mergeScene);
  freshScenes.forEach(mergeScene);
  nextScenes.sort(compareScenes);
  var activeScenesCount = 0;
  nextScenes.forEach(function (scene, ii) {
    var isActive = !scene.isStale && scene.index === nextState.index;

    if (isActive !== scene.isActive) {
      nextScenes[ii] = (0, _objectSpread2.default)({}, scene, {
        isActive: isActive
      });
    }

    if (isActive) {
      activeScenesCount++;
    }
  });

  if (activeScenesCount !== 1) {
    throw new Error("There should always be only one scene active, not " + activeScenesCount + ".");
  }

  if (nextScenes.length !== scenes.length) {
    return nextScenes;
  }

  if (nextScenes.some(function (scene, index) {
    return !areScenesShallowEqual(scenes[index], scene);
  })) {
    return nextScenes;
  }

  return scenes;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNjZW5lc1JlZHVjZXIudHN4Il0sIm5hbWVzIjpbIlNDRU5FX0tFWV9QUkVGSVgiLCJkZWx0YSIsIm9uZSIsInR3byIsImNvbXBhcmVLZXkiLCJhcmVSb3V0ZXNTaGFsbG93RXF1YWwiLCJzY2VuZXMiLCJyb3V0ZSIsInNjZW5lIiwiZGVzY3JpcHRvcnMiLCJwcmV2U3RhdGUiLCJwcmV2U2NlbmVzIiwiZnJlc2hTY2VuZXMiLCJzdGFsZVNjZW5lcyIsImtleSIsIm5leHRLZXlzIiwibmV4dFJvdXRlcyIsIm5leHRTdGF0ZSIsImNvbnNvbGUiLCJkZXNjcmlwdG9yIiwiaW5kZXgiLCJpc0FjdGl2ZSIsImlzU3RhbGUiLCJwcmV2Um91dGVzIiwibGFzdFNjZW5lIiwibmV4dFNjZW5lcyIsIm1lcmdlU2NlbmUiLCJuZXh0U2NlbmUiLCJwcmV2U2NlbmUiLCJhcmVTY2VuZXNTaGFsbG93RXF1YWwiLCJhY3RpdmVTY2VuZXNDb3VudCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsSUFBQSxhQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLENBQUEsdUJBQUEsQ0FBQSxDQUFBOztBQUdBLElBQU1BLGdCQUFnQixHQUF0QixRQUFBOztBQUtBLFNBQUEsVUFBQSxDQUFBLEdBQUEsRUFBQSxHQUFBLEVBQThDO0FBQzVDLE1BQU1DLEtBQUssR0FBR0MsR0FBRyxDQUFIQSxNQUFBQSxHQUFhQyxHQUFHLENBQTlCLE1BQUE7O0FBQ0EsTUFBSUYsS0FBSyxHQUFULENBQUEsRUFBZTtBQUNiLFdBQUEsQ0FBQTtBQUVGOztBQUFBLE1BQUlBLEtBQUssR0FBVCxDQUFBLEVBQWU7QUFDYixXQUFPLENBQVAsQ0FBQTtBQUVGOztBQUFBLFNBQU9DLEdBQUcsR0FBSEEsR0FBQUEsR0FBQUEsQ0FBQUEsR0FBZ0IsQ0FBdkIsQ0FBQTtBQU1GOztBQUFBLFNBQUEsYUFBQSxDQUFBLEdBQUEsRUFBQSxHQUFBLEVBQStDO0FBQzdDLE1BQUlBLEdBQUcsQ0FBSEEsS0FBQUEsR0FBWUMsR0FB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R0FBTixHQUFNLENBQU47QUFLRjs7QUFBQSxNQUFJTCxVQUFVLENBQVZBLE1BQUFBLEtBQXNCbkIsTUFBTSxDQUFoQyxNQUFBLEVBQXlDO0FBQ3ZDLFdBQUEsVUFBQTtBQUdGOztBQUFBLE1BQ0VtQixVQUFVLENBQVZBLElBQUFBLENBQ0UsVUFBQSxLQUFBLEVBQUEsS0FBQSxFQUFBO0FBQUEsV0FBa0IsQ0FBQ0kscUJBQXFCLENBQUN2QixNQUFNLENBQVAsS0FBTyxDQUFQLEVBQXhDLEtBQXdDLENBQXhDO0FBRkosR0FDRW1CLENBREYsRUFJRTtBQUNBLFdBQUEsVUFBQTtBQUlGOztBQUFBLFNBQUEsTUFBQTtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHNoYWxsb3dFcXVhbCBmcm9tICcuLi91dGlscy9zaGFsbG93RXF1YWwnO1xuaW1wb3J0IHsgU2NlbmUsIFJvdXRlLCBOYXZpZ2F0aW9uU3RhdGUsIFNjZW5lRGVzY3JpcHRvciB9IGZyb20gJy4uL3R5cGVzJztcblxuY29uc3QgU0NFTkVfS0VZX1BSRUZJWCA9ICdzY2VuZV8nO1xuXG4vKipcbiAqIEhlbHBlciBmdW5jdGlvbiB0byBjb21wYXJlIHJvdXRlIGtleXMgKGUuZy4gXCI5XCIsIFwiMTFcIikuXG4gKi9cbmZ1bmN0aW9uIGNvbXBhcmVLZXkob25lOiBzdHJpbmcsIHR3bzogc3RyaW5nKSB7XG4gIGNvbnN0IGRlbHRhID0gb25lLmxlbmd0aCAtIHR3by5sZW5ndGg7XG4gIGlmIChkZWx0YSA+IDApIHtcbiAgICByZXR1cm4gMTtcbiAgfVxuICBpZiAoZGVsdGEgPCAwKSB7XG4gICAgcmV0dXJuIC0xO1xuICB9XG4gIHJldHVybiBvbmUgPiB0d28gPyAxIDogLTE7XG59XG5cbi8qKlxuICogSGVscGVyIGZ1bmN0aW9uIHRvIHNvcnQgc2NlbmVzIGJhc2VkIG9uIHRoZWlyIGluZGV4IGFuZCB2aWV3IGtleS5cbiAqL1xuZnVuY3Rpb24gY29tcGFyZVNjZW5lcyhvbmU6IFNjZW5lLCB0d286IFNjZW5lKSB7XG4gIGlmIChvbmUuaW5kZXggPiB0d28uaW5kZXgpIHtcbiAgICByZXR1cm4gMTtcbiAgfVxuICBpZiAob25lLmluZGV4IDwgdHdvLmluZGV4KSB7XG4gICAgcmV0dXJuIC0xO1xuICB9XG5cbiAgcmV0dXJuIGNvbXBhcmVLZXkob25lLmtleSwgdHdvLmtleSk7XG59XG5cbi8qKlxuICogV2hldGhlciB0d28gcm91dGVzIGFyZSB0aGUgc2FtZS5cbiAqL1xuZnVuY3Rpb24gYXJlU2NlbmVzU2hhbGxvd0VxdWFsKG9uZTogU2NlbmUsIHR3bzogU2NlbmUpIHtcbiAgcmV0dXJuIChcbiAgICBvbmUua2V5ID09PSB0d28ua2V5ICYmXG4gICAgb25lLmluZGV4ID09PSB0d28uaW5kZXggJiZcbiAgICBvbmUuaXNTdGFsZSA9PT0gdHdvLmlzU3RhbGUgJiZcbiAgICBvbmUuaXNBY3RpdmUgPT09IHR3by5pc0FjdGl2ZSAmJlxuICAgIGFyZVJvdXRlc1NoYWxsb3dFcXVhbChvbmUucm91dGUsIHR3by5yb3V0ZSlcbiAgKTtcbn1cblxuLyoqXG4gKiBXaGV0aGVyIHR3byByb3V0ZXMgYXJlIHRoZSBzYW1lLlxuICovXG5mdW5jdGlvbiBhcmVSb3V0ZXNTaGFsbG93RXF1YWwob25lOiBSb3V0ZSwgdHdvOiBSb3V0ZSkge1xuICBpZiAoIW9uZSB8fCAhdHdvKSB7XG4gICAgcmV0dXJuIG9uZSA9PT0gdHdvO1xuICB9XG5cbiAgaWYgKG9uZS5rZXkgIT09IHR3by5rZXkpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gc2hhbGxvd0VxdWFsKG9uZSwgdHdvKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gU2NlbmVzUmVkdWNlcihcbiAgc2NlbmVzOiBTY2VuZVtdLFxuICBuZXh0U3RhdGU6IE5hdmlnYXRpb25TdGF0ZSxcbiAgcHJldlN0YXRlOiBOYXZpZ2F0aW9uU3RhdGUgfCBudWxsLFxuICBkZXNjcmlwdG9yczogeyBba2V5OiBzdHJpbmddOiBTY2VuZURlc2NyaXB0b3IgfVxuKSB7XG4gIC8vIEFsd2F5cyB1cGRhdGUgdGhlIGRlc2NyaXB0b3JzXG4gIC8vIFRoaXMgaXMgYSB3b3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vcmVhY3QtbmF2aWdhdGlvbi9yZWFjdC1uYXZpZ2F0aW9uL2lzc3Vlcy80MjcxXG4gIC8vIEl0IHdpbGwgYmUgcmVzb2x2ZWQgaW4gYSBiZXR0ZXIgd2F5IHdoZW4gd2UgcmUtd3JpdGUgVHJhbnNpdGlvbmVyXG4gIHNjZW5lcy5mb3JFYWNoKHNjZW5lID0+IHtcbiAgICBjb25zdCB7IHJvdXRlIH0gPSBzY2VuZTtcbiAgICBpZiAoZGVzY3JpcHRvcnMgJiYgZGVzY3JpcHRvcnNbcm91dGUua2V5XSkge1xuICAgICAgc2NlbmUuZGVzY3JpcHRvciA9IGRlc2NyaXB0b3JzW3JvdXRlLmtleV07XG4gICAgfVxuICB9KTtcblxuICAvLyBCYWlsIG91dCBlYXJseSBpZiB3ZSBkaWRuJ3QgdXBkYXRlIHRoZSBzdGF0ZVxuICBpZiAocHJldlN0YXRlID09PSBuZXh0U3RhdGUpIHtcbiAgICByZXR1cm4gc2NlbmVzO1xuICB9XG5cbiAgY29uc3QgcHJldlNjZW5lcyA9IG5ldyBNYXAoKTtcbiAgY29uc3QgZnJlc2hTY2VuZXMgPSBuZXcgTWFwKCk7XG4gIGNvbnN0IHN0YWxlU2NlbmVzID0gbmV3IE1hcCgpO1xuXG4gIC8vIFBvcHVsYXRlIHN0YWxlIHNjZW5lcyBmcm9tIHByZXZpb3VzIHNjZW5lcyBtYXJrZWQgYXMgc3RhbGUuXG4gIHNjZW5lcy5mb3JFYWNoKHNjZW5lID0+IHtcbiAgICBjb25zdCB7IGtleSB9ID0gc2NlbmU7XG4gICAgaWYgKHNjZW5lLmlzU3RhbGUpIHtcbiAgICAgIHN0YWxlU2NlbmVzLnNldChrZXksIHNjZW5lKTtcbiAgICB9XG4gICAgcHJldlNjZW5lcy5zZXQoa2V5LCBzY2VuZSk7XG4gIH0pO1xuXG4gIGNvbnN0IG5leHRLZXlzID0gbmV3IFNldCgpO1xuICBsZXQgbmV4dFJvdXRlcyA9IG5leHRTdGF0ZS5yb3V0ZXM7XG4gIGlmIChuZXh0Um91dGVzLmxlbmd0aCA+IG5leHRTdGF0ZS5pbmRleCArIDEpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnU3RhY2tSb3V0ZXIgcHJvdmlkZWQgaW52YWxpZCBzdGF0ZSwgaW5kZXggc2hvdWxkIGFsd2F5cyBiZSB0aGUgdG9wIHJvdXRlJ1xuICAgICk7XG4gICAgbmV4dFJvdXRlcyA9IG5leHRTdGF0ZS5yb3V0ZXMuc2xpY2UoMCwgbmV4dFN0YXRlLmluZGV4ICsgMSk7XG4gIH1cblxuICBuZXh0Um91dGVzLmZvckVhY2goKHJvdXRlLCBpbmRleCkgPT4ge1xuICAgIGNvbnN0IGtleSA9IFNDRU5FX0tFWV9QUkVGSVggKyByb3V0ZS5rZXk7XG5cbiAgICBsZXQgZGVzY3JpcHRvciA9IGRlc2NyaXB0b3JzICYmIGRlc2NyaXB0b3JzW3JvdXRlLmtleV07XG5cbiAgICBjb25zdCBzY2VuZTogU2NlbmUgPSB7XG4gICAgICBpbmRleCxcbiAgICAgIGlzQWN0aXZlOiBmYWxzZSxcbiAgICAgIGlzU3RhbGU6IGZhbHNlLFxuICAgICAga2V5LFxuICAgICAgcm91dGUsXG4gICAgICBkZXNjcmlwdG9yLFxuICAgIH07XG5cbiAgICBpZiAobmV4dEtleXMuaGFzKGtleSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYG5hdmlnYXRpb24uc3RhdGUucm91dGVzWyR7aW5kZXh9XS5rZXkgXCIke2tleX1cIiBjb25mbGljdHMgd2l0aCBgICtcbiAgICAgICAgICAnYW5vdGhlciByb3V0ZSEnXG4gICAgICApO1xuICAgIH1cblxuICAgIG5leHRLZXlzLmFkZChrZXkpO1xuXG4gICAgaWYgKHN0YWxlU2NlbmVzLmhhcyhrZXkpKSB7XG4gICAgICAvLyBBIHByZXZpb3VzbHkgYHN0YWxlYCBzY2VuZSBpcyBub3cgcGFydCBvZiB0aGUgbmV4dFN0YXRlLCBzbyB3ZVxuICAgICAgLy8gcmV2aXZlIGl0IGJ5IHJlbW92aW5nIGl0IGZyb20gdGhlIHN0YWxlIHNjZW5lIG1hcC5cbiAgICAgIHN0YWxlU2NlbmVzLmRlbGV0ZShrZXkpO1xuICAgIH1cbiAgICBmcmVzaFNjZW5lcy5zZXQoa2V5LCBzY2VuZSk7XG4gIH0pO1xuXG4gIGlmIChwcmV2U3RhdGUpIHtcbiAgICBsZXQgcHJldlJvdXRlcyA9IHByZXZTdGF0ZS5yb3V0ZXM7XG4gICAgaWYgKHByZXZSb3V0ZXMubGVuZ3RoID4gcHJldlN0YXRlLmluZGV4ICsgMSkge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAnU3RhY2tSb3V0ZXIgcHJvdmlkZWQgaW52YWxpZCBzdGF0ZSwgaW5kZXggc2hvdWxkIGFsd2F5cyBiZSB0aGUgdG9wIHJvdXRlJ1xuICAgICAgKTtcbiAgICAgIHByZXZSb3V0ZXMgPSBwcmV2Um91dGVzLnNsaWNlKDAsIHByZXZTdGF0ZS5pbmRleCArIDEpO1xuICAgIH1cbiAgICAvLyBMb29rIGF0IHRoZSBwcmV2aW91cyByb3V0ZXMgYW5kIGNsYXNzaWZ5IGFueSByZW1vdmVkIHNjZW5lcyBhcyBgc3RhbGVgLlxuICAgIHByZXZSb3V0ZXMuZm9yRWFjaCgocm91dGUsIGluZGV4KSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBTQ0VORV9LRVlfUFJFRklYICsgcm91dGUua2V5O1xuICAgICAgaWYgKGZyZXNoU2NlbmVzLmhhcyhrZXkpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGxhc3RTY2VuZSA9IHNjZW5lcy5maW5kKHNjZW5lID0+IHNjZW5lLnJvdXRlLmtleSA9PT0gcm91dGUua2V5KTtcblxuICAgICAgLy8gV2UgY2FuIGdldCBpbnRvIGEgd2VpcmQgcGxhY2Ugd2hlcmUgd2UgaGF2ZSBhIHF1ZXVlZCB0cmFuc2l0aW9uIGFuZCB0aGVuIGNsb2JiZXJcbiAgICAgIC8vIHRoYXQgdHJhbnNpdGlvbiB3aXRob3V0IGV2ZXIgYWN0dWFsbHkgcmVuZGVyaW5nIHRoZSBzY2VuZSwgaW4gd2hpY2ggY2FzZVxuICAgICAgLy8gdGhlcmUgaXMgbm8gbGFzdFNjZW5lLiBJZiB0aGUgZGVzY3JpcHRvciBpcyBub3QgYXZhaWxhYmxlIG9uIHRoZSBsYXN0U2NlbmVcbiAgICAgIC8vIG9yIHRoZSBkZXNjcmlwdG9ycyBwcm9wIHRoZW4gd2UganVzdCBza2lwIGFkZGluZyBpdCB0byBzdGFsZSBzY2VuZXMgYW5kIGl0J3NcbiAgICAgIC8vIG5vdCBldmVyIHJlbmRlcmVkLlxuICAgICAgY29uc3QgZGVzY3JpcHRvciA9IGxhc3RTY2VuZVxuICAgICAgICA/IGxhc3RTY2VuZS5kZXNjcmlwdG9yXG4gICAgICAgIDogZGVzY3JpcHRvcnNbcm91dGUua2V5XTtcblxuICAgICAgaWYgKGRlc2NyaXB0b3IpIHtcbiAgICAgICAgc3RhbGVTY2VuZXMuc2V0KGtleSwge1xuICAgICAgICAgIGluZGV4LFxuICAgICAgICAgIGlzQWN0aXZlOiBmYWxzZSxcbiAgICAgICAgICBpc1N0YWxlOiB0cnVlLFxuICAgICAgICAgIGtleSxcbiAgICAgICAgICByb3V0ZSxcbiAgICAgICAgICBkZXNjcmlwdG9yLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IG5leHRTY2VuZXM6IFNjZW5lW10gPSBbXTtcblxuICBjb25zdCBtZXJnZVNjZW5lID0gKG5leHRTY2VuZTogU2NlbmUpID0+IHtcbiAgICBjb25zdCB7IGtleSB9ID0gbmV4dFNjZW5lO1xuICAgIGNvbnN0IHByZXZTY2VuZSA9IHByZXZTY2VuZXMuaGFzKGtleSkgPyBwcmV2U2NlbmVzLmdldChrZXkpIDogbnVsbDtcbiAgICBpZiAocHJldlNjZW5lICYmIGFyZVNjZW5lc1NoYWxsb3dFcXVhbChwcmV2U2NlbmUsIG5leHRTY2VuZSkpIHtcbiAgICAgIC8vIFJldXNlIGBwcmV2U2NlbmVgIGFzIGBzY2VuZWAgc28gdmlldyBjYW4gYXZvaWQgdW5uZWNlc3NhcnkgcmUtcmVuZGVyLlxuICAgICAgLy8gVGhpcyBhc3N1bWVzIHRoYXQgdGhlIHNjZW5lJ3MgbmF2aWdhdGlvbiBzdGF0ZSBpcyBpbW11dGFibGUuXG4gICAgICBuZXh0U2NlbmVzLnB1c2gocHJldlNjZW5lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbmV4dFNjZW5lcy5wdXNoKG5leHRTY2VuZSk7XG4gICAgfVxuICB9O1xuXG4gIHN0YWxlU2NlbmVzLmZvckVhY2gobWVyZ2VTY2VuZSk7XG4gIGZyZXNoU2NlbmVzLmZvckVhY2gobWVyZ2VTY2VuZSk7XG5cbiAgbmV4dFNjZW5lcy5zb3J0KGNvbXBhcmVTY2VuZXMpO1xuXG4gIGxldCBhY3RpdmVTY2VuZXNDb3VudCA9IDA7XG4gIG5leHRTY2VuZXMuZm9yRWFjaCgoc2NlbmUsIGlpKSA9PiB7XG4gICAgY29uc3QgaXNBY3RpdmUgPSAhc2NlbmUuaXNTdGFsZSAmJiBzY2VuZS5pbmRleCA9PT0gbmV4dFN0YXRlLmluZGV4O1xuICAgIGlmIChpc0FjdGl2ZSAhPT0gc2NlbmUuaXNBY3RpdmUpIHtcbiAgICAgIG5leHRTY2VuZXNbaWldID0ge1xuICAgICAgICAuLi5zY2VuZSxcbiAgICAgICAgaXNBY3RpdmUsXG4gICAgICB9O1xuICAgIH1cbiAgICBpZiAoaXNBY3RpdmUpIHtcbiAgICAgIGFjdGl2ZVNjZW5lc0NvdW50Kys7XG4gICAgfVxuICB9KTtcblxuICBpZiAoYWN0aXZlU2NlbmVzQ291bnQgIT09IDEpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlcmUgc2hvdWxkIGFsd2F5cyBiZSBvbmx5IG9uZSBzY2VuZSBhY3RpdmUsIG5vdCAke2FjdGl2ZVNjZW5lc0NvdW50fS5gXG4gICAgKTtcbiAgfVxuXG4gIGlmIChuZXh0U2NlbmVzLmxlbmd0aCAhPT0gc2NlbmVzLmxlbmd0aCkge1xuICAgIHJldHVybiBuZXh0U2NlbmVzO1xuICB9XG5cbiAgaWYgKFxuICAgIG5leHRTY2VuZXMuc29tZShcbiAgICAgIChzY2VuZSwgaW5kZXgpID0+ICFhcmVTY2VuZXNTaGFsbG93RXF1YWwoc2NlbmVzW2luZGV4XSwgc2NlbmUpXG4gICAgKVxuICApIHtcbiAgICByZXR1cm4gbmV4dFNjZW5lcztcbiAgfVxuXG4gIC8vIHNjZW5lcyBoYXZlbid0IGNoYW5nZWQuXG4gIHJldHVybiBzY2VuZXM7XG59XG4iXX0=