e70e2bc4c9cd205ef9252581eca50247
var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getTransitionElements = exports.getCalculatedTransitionStyle = void 0;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _react = _interopRequireDefault(require("react"));

var _reactNative = require("react-native");

var _Utils = require("../Utils");

var _TransitionTypes = require("./TransitionTypes");

var Constants = _interopRequireWildcard(require("../TransitionConstants"));

var _TransitionItem = _interopRequireDefault(require("../TransitionItem"));

var _Types = require("../Types");

var getTransitionElements = function getTransitionElements(transitionElements, transitionContext) {
  return transitionElements.map(function (item, idx) {
    var routeDirection = transitionContext.getDirectionForRoute(item.name, item.route);

    var element = _react.default.Children.only(item.reactElement.props.children);

    var key = "ti-" + idx.toString();
    var transitionStyle = getComponentStyle(item, routeDirection === _Types.RouteDirection.from ? transitionContext.delayCountFrom + 1 : transitionContext.delayCountTo + 1, routeDirection === _Types.RouteDirection.from ? transitionContext.delayIndexFrom : transitionContext.delayIndexTo, transitionContext);
    var style = [transitionStyle, styles.transitionElement];
    var props = (0, _objectSpread2.default)({}, element.props, {
      __index: item.index
    });
    element = _react.default.createElement(element.type, (0, _objectSpread2.default)({}, props, {
      key: key
    }));
    var comp = (0, _Utils.createAnimatedWrapper)({
      component: element,
      nativeStyles: style
    });

    if (item.delay) {
      if (routeDirection === _Types.RouteDirection.from) {
        transitionContext.delayIndexFrom += transitionContext.delayFromFactor;
      } else {
        transitionContext.delayIndexTo += transitionContext.delayToFactor;
      }
    }

    return comp;
  });
};

exports.getTransitionElements = getTransitionElements;

var getComponentStyle = function getComponentStyle(item, delayCount, delayIndex, transitionContext) {
  var index = transitionContext.getIndex();
  var routeDirection = transitionContext.getDirectionForRoute(item.name, item.route);
  var progress = transitionContext.getTransitionProgress();
  var routes = transitionContext.getRoutes();
  var transitionStyle = progress ? getCalculatedTransitionStyle(item, delayCount, delayIndex, index, routeDirection, progress, routes.length === 1) : {};
  var resolvedMetrics = (0, _Utils.getResolvedMetrics)(item, item.metrics);
  return (0, _objectSpread2.default)({
    left: resolvedMetrics.x,
    top: resolvedMetrics.y,
    width: resolvedMetrics.width,
    height: resolvedMetrics.height
  }, transitionStyle);
};

var getCalculatedTransitionStyle = function getCalculatedTransitionStyle(item, delayCount, delayIndex, index, routeDirection, progress, singleRoute) {
  var transitionFunction = getTransitionFunction(item, routeDirection);

  if (transitionFunction) {
    var start = Constants.TRANSITION_PROGRESS_START;
    var end = Constants.TRANSITION_PROGRESS_END;
    var distance = !singleRoute ? (1.0 - (Constants.TRANSITION_PROGRESS_START + (1.0 - Constants.TRANSITION_PROGRESS_END))) * 0.5 : 1.0 - (Constants.TRANSITION_PROGRESS_START + (1.0 - Constants.TRANSITION_PROGRESS_END));

    if (item.delay) {
      var delayStep = distance / delayCount;

      if (routeDirection === _Types.RouteDirection.from) {
        start += delayStep * delayIndex;
      } else {
        end -= delayStep * delayIndex;
      }
    } else if (!singleRoute) {
      if (routeDirection === _Types.RouteDirection.to) {
        start += distance;
      } else {
        end -= distance;
      }
    }

    var interpolatedProgress = progress.interpolate({
      inputRange: [index - 1, index, index + 1],
      outputRange: [0, 1, 0]
    });
    var transitionSpecification = {
      progress: interpolatedProgress,
      name: item.name,
      route: item.route,
      metrics: item.metrics,
      boundingbox: item.boundingBoxMetrics,
      direction: routeDirection,
      dimensions: _reactNative.Dimensions.get('window'),
      start: start,
      end: end
    };
    return transitionFunction(transitionSpecification);
  }

  return {};
};

exports.getCalculatedTransitionStyle = getCalculatedTransitionStyle;

var getTransitionFunction = function getTransitionFunction(item, routeDirection) {
  var getTransition = function getTransition(transition) {
    if (transition instanceof Function) {
      return transition;
    }

    return (0, _TransitionTypes.getTransitionType)(transition);
  };

  if (routeDirection === _Types.RouteDirection.to && item.appear) {
    return getTransition(item.appear);
  }

  if (routeDirection === _Types.RouteDirection.from && item.disappear) {
    return getTransition(item.disappear);
  }

  if (item.appear) {
    return getTransition(item.appear);
  }

  return null;
};

var styles = _reactNative.StyleSheet.create({
  transitionElement: {
    position: 'absolute'
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdldFRyYW5zaXRpb25FbGVtZW50cy5qcyJdLCJuYW1lcyI6WyJnZXRUcmFuc2l0aW9uRWxlbWVudHMiLCJ0cmFuc2l0aW9uRWxlbWVudHMiLCJ0cmFuc2l0aW9uQ29udGV4dCIsIm1hcCIsIml0ZW0iLCJpZHgiLCJyb3V0ZURpcmVjdGlvbiIsImdldERpcmVjdGlvbkZvclJvdXRlIiwibmFtZSIsInJvdXRlIiwiZWxlbWVudCIsIlJlYWN0IiwiQ2hpbGRyZW4iLCJvbmx5IiwicmVhY3RFbGVtZW50IiwicHJvcHMiLCJjaGlsZHJlbiIsImtleSIsInRvU3RyaW5nIiwidHJhbnNpdGlvblN0eWxlIiwiZ2V0Q29tcG9uZW50U3R5bGUiLCJSb3V0ZURpcmVjdGlvbiIsImZyb20iLCJkZWxheUNvdW50RnJvbSIsImRlbGF5Q291bnRUbyIsImRlbGF5SW5kZXhGcm9tIiwiZGVsYXlJbmRleFRvIiwic3R5bGUiLCJzdHlsZXMiLCJ0cmFuc2l0aW9uRWxlbWVudCIsIl9faW5kZXgiLCJpbmRleCIsImNyZWF0ZUVsZW1lbnQiLCJ0eXBlIiwiY29tcCIsImNvbXBvbmVudCIsIm5hdGl2ZVN0eWxlcyIsImRlbGF5IiwiZGVsYXlGcm9tRmFjdG9yIiwiZGVsYXlUb0ZhY3RvciIsImRlbGF5Q291bnQiLCJkZWxheUluZGV4IiwiZ2V0SW5kZXgiLCJwcm9ncmVzcyIsImdldFRyYW5zaXRpb25Qcm9ncmVzcyIsInJvdXRlcyIsImdldFJvdXRlcyIsImdldENhbGN1bGF0ZWRUcmFuc2l0aW9uU3R5bGUiLCJsZW5ndGgiLCJyZXNvbHZlZE1ldHJpY3MiLCJtZXRyaWNzIiwibGVmdCIsIngiLCJ0b3AiLCJ5Iiwid2lkdGgiLCJoZWlnaHQiLCJzaW5nbGVSb3V0ZSIsInRyYW5zaXRpb25GdW5jdGlvbiIsImdldFRyYW5zaXRpb25GdW5jdGlvbiIsInN0YXJ0IiwiQ29uc3RhbnRzIiwiVFJBTlNJVElPTl9QUk9HUkVTU19TVEFSVCIsImVuZCIsIlRSQU5TSVRJT05fUFJPR1JFU1NfRU5EIiwiZGlzdGFuY2UiLCJkZWxheVN0ZXAiLCJ0byIsImludGVycG9sYXRlZFByb2dyZXNzIiwiaW50ZXJwb2xhdGUiLCJpbnB1dFJhbmdlIiwib3V0cHV0UmFuZ2UiLCJ0cmFuc2l0aW9uU3BlY2lmaWNhdGlvbiIsImJvdW5kaW5nYm94IiwiYm91bmRpbmdCb3hNZXRyaWNzIiwiZGlyZWN0aW9uIiwiZGltZW5zaW9ucyIsIkRpbWVuc2lvbnMiLCJnZXQiLCJnZXRUcmFuc2l0aW9uIiwidHJhbnNpdGlvbiIsIkZ1bmN0aW9uIiwiYXBwZWFyIiwiZGlzYXBwZWFyIiwiU3R5bGVTaGVldCIsImNyZWF0ZSIsInBvc2l0aW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQU9BLElBQU1BLHFCQUFxQixHQUFHLFNBQXhCQSxxQkFBd0IsQ0FBQ0Msa0JBQUQsRUFDNUJDLGlCQUQ0QjtBQUFBLFNBQ2FELGtCQUFrQixDQUFDRSxHQUFuQixDQUF1QixVQUFDQyxJQUFELEVBQU9DLEdBQVAsRUFBZTtBQUMvRSxRQUFNQyxjQUFjLEdBQUdKLGlCQUFpQixDQUFDSyxvQkFBbEIsQ0FBdUNILElBQUksQ0FBQ0ksSUFBNUMsRUFBa0RKLElBQUksQ0FBQ0ssS0FBdkQsQ0FBdkI7O0FBQ0EsUUFBSUMsT0FBTyxHQUFHQyxlQUFNQyxRQUFOLENBQWVDLElBQWYsQ0FBb0JULElBQUksQ0FBQ1UsWUFBTCxDQUFrQkMsS0FBbEIsQ0FBd0JDLFFBQTVDLENBQWQ7O0FBQ0EsUUFBTUMsR0FBRyxXQUFTWixHQUFHLENBQUNhLFFBQUosRUFBbEI7QUFFQSxRQUFNQyxlQUFlLEdBQUdDLGlCQUFpQixDQUN2Q2hCLElBRHVDLEVBQ2pDRSxjQUFjLEtBQUtlLHNCQUFlQyxJQUFsQyxHQUNGcEIsaUJBQWlCLENBQUNxQixjQUFsQixHQUFtQyxDQURqQyxHQUNxQ3JCLGlCQUFpQixDQUFDc0IsWUFBbEIsR0FBaUMsQ0FGckMsRUFHdkNsQixjQUFjLEtBQUtl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O0FBQ0QsQ0FkRDs7QUFnQkEsSUFBTXRELE1BQU0sR0FBR3dELHdCQUFXQyxNQUFYLENBQWtCO0FBQy9CeEQsRUFBQUEsaUJBQWlCLEVBQUU7QUFDakJ5RCxJQUFBQSxRQUFRLEVBQUU7QUFETztBQURZLENBQWxCLENBQWYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgRGltZW5zaW9ucywgU3R5bGVTaGVldCB9IGZyb20gJ3JlYWN0LW5hdGl2ZSc7XG5cbmltcG9ydCB7IGNyZWF0ZUFuaW1hdGVkV3JhcHBlciwgZ2V0UmVzb2x2ZWRNZXRyaWNzIH0gZnJvbSAnLi4vVXRpbHMnO1xuaW1wb3J0IHsgZ2V0VHJhbnNpdGlvblR5cGUgfSBmcm9tICcuL1RyYW5zaXRpb25UeXBlcyc7XG5pbXBvcnQgKiBhcyBDb25zdGFudHMgZnJvbSAnLi4vVHJhbnNpdGlvbkNvbnN0YW50cyc7XG5pbXBvcnQgVHJhbnNpdGlvbkl0ZW0gZnJvbSAnLi4vVHJhbnNpdGlvbkl0ZW0nO1xuXG5pbXBvcnQge1xuICBUcmFuc2l0aW9uQ29udGV4dCxcbiAgUm91dGVEaXJlY3Rpb24sXG4gIFRyYW5zaXRpb25TcGVjaWZpY2F0aW9uLFxufSBmcm9tICcuLi9UeXBlcyc7XG5cblxuY29uc3QgZ2V0VHJhbnNpdGlvbkVsZW1lbnRzID0gKHRyYW5zaXRpb25FbGVtZW50czogQXJyYXk8VHJhbnNpdGlvbkl0ZW0+LFxuICB0cmFuc2l0aW9uQ29udGV4dDogVHJhbnNpdGlvbkNvbnRleHQpID0+IHRyYW5zaXRpb25FbGVtZW50cy5tYXAoKGl0ZW0sIGlkeCkgPT4ge1xuICBjb25zdCByb3V0ZURpcmVjdGlvbiA9IHRyYW5zaXRpb25Db250ZXh0LmdldERpcmVjdGlvbkZvclJvdXRlKGl0ZW0ubmFtZSwgaXRlbS5yb3V0ZSk7XG4gIGxldCBlbGVtZW50ID0gUmVhY3QuQ2hpbGRyZW4ub25seShpdGVtLnJlYWN0RWxlbWVudC5wcm9wcy5jaGlsZHJlbik7XG4gIGNvbnN0IGtleSA9IGB0aS0ke2lkeC50b1N0cmluZygpfWA7XG5cbiAgY29uc3QgdHJhbnNpdGlvblN0eWxlID0gZ2V0Q29tcG9uZW50U3R5bGUoXG4gICAgaXRlbSwgcm91dGVEaXJlY3Rpb24gPT09IFJvdXRlRGlyZWN0aW9uLmZyb21cbiAgICAgID8gdHJhbnNpdGlvbkNvbnRleHQuZGVsYXlDb3VudEZyb20gKyAxIDogdHJhbnNpdGlvbkNvbnRleHQuZGVsYXlDb3VudFRvICsgMSxcbiAgICByb3V0ZURpcmVjdGlvbiA9PT0gUm91dGVEaXJlY3Rpb24uZnJvbVxuICAgICAgPyB0cmFuc2l0aW9uQ29udGV4dC5kZWxheUluZGV4RnJvbSA6IHRyYW5zaXRpb25Db250ZXh0LmRlbGF5SW5kZXhUbyxcbiAgICB0cmFuc2l0aW9uQ29udGV4dCxcbiAgKTtcblxuICBjb25zdCBzdHlsZSA9IFt0cmFuc2l0aW9uU3R5bGUsIHN0eWxlcy50cmFuc2l0aW9uRWxlbWVudF07XG4gIGNvbnN0IHByb3BzID0geyAuLi5lbGVtZW50LnByb3BzLCBfX2luZGV4OiBpdGVtLmluZGV4IH07XG4gIGVsZW1lbnQgPSBSZWFjdC5jcmVhdGVFbGVtZW50KGVsZW1lbnQudHlwZSwgeyAuLi5wcm9wcywga2V5IH0pO1xuICBjb25zdCBjb21wID0gY3JlYXRlQW5pbWF0ZWRXcmFwcGVyKHsgY29tcG9uZW50OiBlbGVtZW50LCBuYXRpdmVTdHlsZXM6IHN0eWxlIH0pO1xuXG4gIGlmIChpdGVtLmRlbGF5KSB7XG4gICAgaWYgKHJvdXRlRGlyZWN0aW9uID09PSBSb3V0ZURpcmVjdGlvbi5mcm9tKSB7XG4gICAgICB0cmFuc2l0aW9uQ29udGV4dC5kZWxheUluZGV4RnJvbSArPSB0cmFuc2l0aW9uQ29udGV4dC5kZWxheUZyb21GYWN0b3I7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRyYW5zaXRpb25Db250ZXh0LmRlbGF5SW5kZXhUbyArPSB0cmFuc2l0aW9uQ29udGV4dC5kZWxheVRvRmFjdG9yO1xuICAgIH1cbiAgfVxuICByZXR1cm4gY29tcDtcbn0pO1xuXG5jb25zdCBnZXRDb21wb25lbnRTdHlsZSA9IChcbiAgaXRlbTogVHJhbnNpdGlvbkl0ZW0sIGRlbGF5Q291bnQ6IG51bWJlciwgZGVsYXlJbmRleDogbnVtYmVyLFxuICB0cmFuc2l0aW9uQ29udGV4dDogVHJhbnNpdGlvbkNvbnRleHQsXG4pID0+IHtcbiAgY29uc3QgaW5kZXggPSB0cmFuc2l0aW9uQ29udGV4dC5nZXRJbmRleCgpO1xuICBjb25zdCByb3V0ZURpcmVjdGlvbiA9IHRyYW5zaXRpb25Db250ZXh0LmdldERpcmVjdGlvbkZvclJvdXRlKGl0ZW0ubmFtZSwgaXRlbS5yb3V0ZSk7XG4gIGNvbnN0IHByb2dyZXNzID0gdHJhbnNpdGlvbkNvbnRleHQuZ2V0VHJhbnNpdGlvblByb2dyZXNzKCk7XG4gIGNvbnN0IHJvdXRlcyA9IHRyYW5zaXRpb25Db250ZXh0LmdldFJvdXRlcygpO1xuXG4gIGNvbnN0IHRyYW5zaXRpb25TdHlsZSA9IHByb2dyZXNzID8gZ2V0Q2FsY3VsYXRlZFRyYW5zaXRpb25TdHlsZShcbiAgICBpdGVtLFxuICAgIGRlbGF5Q291bnQsXG4gICAgZGVsYXlJbmRleCxcbiAgICBpbmRleCxcbiAgICByb3V0ZURpcmVjdGlvbixcbiAgICBwcm9ncmVzcyxcbiAgICByb3V0ZXMubGVuZ3RoID09PSAxLFxuICApIDoge307XG5cbiAgY29uc3QgcmVzb2x2ZWRNZXRyaWNzID0gZ2V0UmVzb2x2ZWRNZXRyaWNzKGl0ZW0sIGl0ZW0ubWV0cmljcyk7XG4gIHJldHVybiB7XG4gICAgbGVmdDogcmVzb2x2ZWRNZXRyaWNzLngsXG4gICAgdG9wOiByZXNvbHZlZE1ldHJpY3MueSxcbiAgICB3aWR0aDogcmVzb2x2ZWRNZXRyaWNzLndpZHRoLFxuICAgIGhlaWdodDogcmVzb2x2ZWRNZXRyaWNzLmhlaWdodCxcbiAgICAuLi50cmFuc2l0aW9uU3R5bGUsXG4gIH07XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0Q2FsY3VsYXRlZFRyYW5zaXRpb25TdHlsZSA9IChcbiAgaXRlbSxcbiAgZGVsYXlDb3VudCxcbiAgZGVsYXlJbmRleCxcbiAgaW5kZXgsXG4gIHJvdXRlRGlyZWN0aW9uLFxuICBwcm9ncmVzcyxcbiAgc2luZ2xlUm91dGUsXG4pID0+IHtcbiAgY29uc3QgdHJhbnNpdGlvbkZ1bmN0aW9uID0gZ2V0VHJhbnNpdGlvbkZ1bmN0aW9uKGl0ZW0sIHJvdXRlRGlyZWN0aW9uKTtcbiAgaWYgKHRyYW5zaXRpb25GdW5jdGlvbikge1xuICAgIC8vIENhbGN1bGF0ZSBzdGFydC9lbmQgdG8gaGFuZGxlIGRlbGF5ZWQgdHJhbnNpdGlvbnNcbiAgICBsZXQgc3RhcnQgPSBDb25zdGFudHMuVFJBTlNJVElPTl9QUk9HUkVTU19TVEFSVDtcbiAgICBsZXQgZW5kID0gQ29uc3RhbnRzLlRSQU5TSVRJT05fUFJPR1JFU1NfRU5EO1xuXG4gICAgY29uc3QgZGlzdGFuY2UgPSAhc2luZ2xlUm91dGVcbiAgICAgID8gKDEuMCAtIChDb25zdGFudHMuVFJBTlNJVElPTl9QUk9HUkVTU19TVEFSVFxuICAgICAgKyAoMS4wIC0gQ29uc3RhbnRzLlRSQU5TSVRJT05fUFJPR1JFU1NfRU5EKSkpICogMC41XG4gICAgICA6ICgxLjAgLSAoQ29uc3RhbnRzLlRSQU5TSVRJT05fUFJPR1JFU1NfU1RBUlRcbiAgICAgICsgKDEuMCAtIENvbnN0YW50cy5UUkFOU0lUSU9OX1BST0dSRVNTX0VORCkpKTtcblxuICAgIGlmIChpdGVtLmRlbGF5KSB7XG4gICAgICAvLyBTdGFydC9zdG9wIGluIGRlbGF5IHdpbmRvd1xuICAgICAgY29uc3QgZGVsYXlTdGVwID0gZGlzdGFuY2UgLyBkZWxheUNvdW50O1xuICAgICAgaWYgKHJvdXRlRGlyZWN0aW9uID09PSBSb3V0ZURpcmVjdGlvbi5mcm9tKSB7XG4gICAgICAgIHN0YXJ0ICs9IChkZWxheVN0ZXAgKiBkZWxheUluZGV4KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVuZCAtPSAoZGVsYXlTdGVwICogZGVsYXlJbmRleCk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICghc2luZ2xlUm91dGUpIHtcbiAgICAgIC8vIFN0YXJ0L3N0b3AgZmlyc3QvbGFzdCBoYWxmIG9mIHRyYW5zaXRpb25cbiAgICAgIGlmIChyb3V0ZURpcmVjdGlvbiA9PT0gUm91dGVEaXJlY3Rpb24udG8pIHtcbiAgICAgICAgc3RhcnQgKz0gZGlzdGFuY2U7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBlbmQgLT0gZGlzdGFuY2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gY29uc29sZS5sb2coaXRlbS5uYW1lLCBkZWxheUluZGV4LCByb3V0ZURpcmVjdGlvbiwgZGVsYXlDb3VudCwgZGlzdGFuY2UsIHN0YXJ0LCBlbmQpO1xuXG4gICAgLy8gQ3JlYXRlIHByb2dyZXNzIGludGVycG9sYXRpb25cbiAgICBjb25zdCBpbnRlcnBvbGF0ZWRQcm9ncmVzcyA9IHByb2dyZXNzLmludGVycG9sYXRlKHtcbiAgICAgIGlucHV0UmFuZ2U6IFtpbmRleCAtIDEsIGluZGV4LCBpbmRleCArIDFdLFxuICAgICAgb3V0cHV0UmFuZ2U6IFswLCAxLCAwXSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHRyYW5zaXRpb25TcGVjaWZpY2F0aW9uOiBUcmFuc2l0aW9uU3BlY2lmaWNhdGlvbiA9IHtcbiAgICAgIHByb2dyZXNzOiBpbnRlcnBvbGF0ZWRQcm9ncmVzcyxcbiAgICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICAgIHJvdXRlOiBpdGVtLnJvdXRlLFxuICAgICAgbWV0cmljczogaXRlbS5tZXRyaWNzLFxuICAgICAgYm91bmRpbmdib3g6IGl0ZW0uYm91bmRpbmdCb3hNZXRyaWNzLFxuICAgICAgZGlyZWN0aW9uOiByb3V0ZURpcmVjdGlvbixcbiAgICAgIGRpbWVuc2lvbnM6IERpbWVuc2lvbnMuZ2V0KCd3aW5kb3cnKSxcbiAgICAgIHN0YXJ0LFxuICAgICAgZW5kLFxuICAgIH07XG5cbiAgICByZXR1cm4gdHJhbnNpdGlvbkZ1bmN0aW9uKHRyYW5zaXRpb25TcGVjaWZpY2F0aW9uKTtcbiAgfVxuXG4gIHJldHVybiB7fTtcbn07XG5cbmNvbnN0IGdldFRyYW5zaXRpb25GdW5jdGlvbiA9IChpdGVtOiBUcmFuc2l0aW9uSXRlbSwgcm91dGVEaXJlY3Rpb246IFJvdXRlRGlyZWN0aW9uKSA9PiB7XG4gIGNvbnN0IGdldFRyYW5zaXRpb24gPSAodHJhbnNpdGlvbjogc3RyaW5nIHwgRnVuY3Rpb24pID0+IHtcbiAgICBpZiAodHJhbnNpdGlvbiBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7IHJldHVybiB0cmFuc2l0aW9uOyB9XG4gICAgcmV0dXJuIGdldFRyYW5zaXRpb25UeXBlKHRyYW5zaXRpb24pO1xuICB9O1xuXG4gIGlmIChyb3V0ZURpcmVjdGlvbiA9PT0gUm91dGVEaXJlY3Rpb24udG8gJiYgaXRlbS5hcHBlYXIpIHtcbiAgICByZXR1cm4gZ2V0VHJhbnNpdGlvbihpdGVtLmFwcGVhcik7XG4gIH0gaWYgKHJvdXRlRGlyZWN0aW9uID09PSBSb3V0ZURpcmVjdGlvbi5mcm9tICYmIGl0ZW0uZGlzYXBwZWFyKSB7XG4gICAgcmV0dXJuIGdldFRyYW5zaXRpb24oaXRlbS5kaXNhcHBlYXIpO1xuICB9IGlmIChpdGVtLmFwcGVhcikge1xuICAgIHJldHVybiBnZXRUcmFuc2l0aW9uKGl0ZW0uYXBwZWFyKTtcbiAgfVxuICByZXR1cm4gbnVsbDtcbn07XG5cbmNvbnN0IHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHtcbiAgdHJhbnNpdGlvbkVsZW1lbnQ6IHtcbiAgICBwb3NpdGlvbjogJ2Fic29sdXRlJyxcbiAgfSxcbn0pO1xuXG5leHBvcnQgeyBnZXRUcmFuc2l0aW9uRWxlbWVudHMgfTtcbiJdfQ==