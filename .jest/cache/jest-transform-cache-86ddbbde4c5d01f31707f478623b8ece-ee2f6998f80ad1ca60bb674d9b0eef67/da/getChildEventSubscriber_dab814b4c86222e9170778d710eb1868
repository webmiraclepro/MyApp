bafdf90ec9ee21a5057d6316937b6369
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = getChildEventSubscriber;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

function getChildEventSubscriber(addListener, key) {
  var initialLastFocusEvent = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 'didBlur';
  var actionSubscribers = new Set();
  var willFocusSubscribers = new Set();
  var didFocusSubscribers = new Set();
  var willBlurSubscribers = new Set();
  var didBlurSubscribers = new Set();
  var refocusSubscribers = new Set();

  var removeAll = function removeAll() {
    [actionSubscribers, willFocusSubscribers, didFocusSubscribers, willBlurSubscribers, didBlurSubscribers, refocusSubscribers].forEach(function (set) {
      return set.clear();
    });
    upstreamSubscribers.forEach(function (subs) {
      return subs && subs.remove();
    });
  };

  var getChildSubscribers = function getChildSubscribers(evtName) {
    switch (evtName) {
      case 'action':
        return actionSubscribers;

      case 'willFocus':
        return willFocusSubscribers;

      case 'didFocus':
        return didFocusSubscribers;

      case 'willBlur':
        return willBlurSubscribers;

      case 'didBlur':
        return didBlurSubscribers;

      case 'refocus':
        return refocusSubscribers;

      default:
        return null;
    }
  };

  var _emit = function emit(type, payload) {
    var payloadWithType = (0, _objectSpread2.default)({}, payload, {
      type: type
    });
    var subscribers = getChildSubscribers(type);
    subscribers && subscribers.forEach(function (subs) {
      subs(payloadWithType);
    });
  };

  var lastFocusEvent = initialLastFocusEvent;
  var upstreamEvents = ['willFocus', 'didFocus', 'willBlur', 'didBlur', 'refocus', 'action'];
  var upstreamSubscribers = upstreamEvents.map(function (eventName) {
    return addListener(eventName, function (payload) {
      if (eventName === 'refocus') {
        _emit(eventName, payload);

        return;
      }

      var state = payload.state,
          lastState = payload.lastState,
          action = payload.action;
      var lastRoutes = lastState && lastState.routes;
      var routes = state && state.routes;
      var focusKey = routes && routes[state.index].key;
      var isChildFocused = focusKey === key;
      var lastRoute = lastRoutes && lastRoutes.find(function (route) {
        return route.key === key;
      });
      var newRoute = routes && routes.find(function (route) {
        return route.key === key;
      });
      var childPayload = {
        context: key + ":" + action.type + "_" + (payload.context || 'Root'),
        state: newRoute,
        lastState: lastRoute,
        action: action,
        type: eventName
      };
      var isTransitioning = !!state && state.isTransitioning;
      var previouslylastFocusEvent = lastFocusEvent;

      if (lastFocusEvent === 'didBlur') {
        if (eventName === 'willFocus' && isChildFocused) {
          _emit(lastFocusEvent = 'willFocus', childPayload);
        } else if (eventName === 'action' && isChildFocused) {
          _emit(lastFocusEvent = 'willFocus', childPayload);
        }
      }

      if (lastFocusEvent === 'willFocus') {
        if (eventName === 'didFocus' && isChildFocused && !isTransitioning) {
          _emit(lastFocusEvent = 'didFocus', childPayload);
        } else if (eventName === 'action' && isChildFocused && !isTransitioning) {
          _emit(lastFocusEvent = 'didFocus', childPayload);
        }
      }

      if (lastFocusEvent === 'didFocus') {
        if (!isChildFocused) {
          _emit(lastFocusEvent = 'willBlur', childPayload);
        } else if (eventName === 'willBlur') {
          _emit(lastFocusEvent = 'willBlur', childPayload);
        } else if (eventName === 'action' && previouslylastFocusEvent === 'didFocus') {
          _emit('action', childPayload);
        }
      }

      if (lastFocusEvent === 'willBlur') {
        if (eventName === 'action' && !isChildFocused && !isTransitioning) {
          _emit(lastFocusEvent = 'didBlur', childPayload);
        } else if (eventName === 'didBlur') {
          _emit(lastFocusEvent = 'didBlur', childPayload);
        } else if (eventName === 'action' && isChildFocused && !isTransitioning) {
          _emit(lastFocusEvent = 'didFocus', childPayload);
        } else if (eventName === 'action' && isChildFocused && isTransitioning) {
          _emit(lastFocusEvent = 'willFocus', childPayload);
        }
      }

      if (lastFocusEvent === 'didBlur' && !newRoute) {
        removeAll();
      }
    });
  });
  return {
    addListener: function addListener(eventName, eventHandler) {
      var subscribers = getChildSubscribers(eventName);

      if (!subscribers) {
        throw new Error("Invalid event name \"" + eventName + "\"");
      }

      subscribers.add(eventHandler);

      var remove = function remove() {
        subscribers.delete(eventHandler);
      };

      return {
        remove: remove
      };
    },
    emit: function emit(eventName, payload) {
      if (eventName !== 'refocus') {
        console.error("navigation.emit only supports the 'refocus' event currently.");
        return;
      }

      _emit(eventName, payload);
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdldENoaWxkRXZlbnRTdWJzY3JpYmVyLmpzIl0sIm5hbWVzIjpbImluaXRpYWxMYXN0Rm9jdXNFdmVudCIsImFjdGlvblN1YnNjcmliZXJzIiwid2lsbEZvY3VzU3Vic2NyaWJlcnMiLCJkaWRGb2N1c1N1YnNjcmliZXJzIiwid2lsbEJsdXJTdWJzY3JpYmVycyIsImRpZEJsdXJTdWJzY3JpYmVycyIsInJlZm9jdXNTdWJzY3JpYmVycyIsInJlbW92ZUFsbCIsInNldCIsInVwc3RyZWFtU3Vic2NyaWJlcnMiLCJzdWJzIiwiZ2V0Q2hpbGRTdWJzY3JpYmVycyIsImVtaXQiLCJwYXlsb2FkV2l0aFR5cGUiLCJ0eXBlIiwic3Vic2NyaWJlcnMiLCJsYXN0Rm9jdXNFdmVudCIsInVwc3RyZWFtRXZlbnRzIiwiYWRkTGlzdGVuZXIiLCJldmVudE5hbWUiLCJzdGF0ZSIsImxhc3RTdGF0ZSIsImFjdGlvbiIsInBheWxvYWQiLCJsYXN0Um91dGVzIiwicm91dGVzIiwiZm9jdXNLZXkiLCJpc0NoaWxkRm9jdXNlZCIsImxhc3RSb3V0ZSIsInJvdXRlIiwibmV3Um91dGUiLCJjaGlsZFBheWxvYWQiLCJjb250ZXh0Iiwia2V5IiwiaXNUcmFuc2l0aW9uaW5nIiwicHJldmlvdXNseWxhc3RGb2N1c0V2ZW50IiwicmVtb3ZlIiwiY29uc29sZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBTWUsU0FBQSx1QkFBQSxDQUFBLFdBQUEsRUFBQSxHQUFBLEVBSWI7QUFEQUEsTUFBQUEscUJBQ0EsR0FBQSxTQUFBLENBQUEsTUFBQSxHQUFBLENBQUEsSUFBQSxTQUFBLENBQUEsQ0FBQSxDQUFBLEtBQUEsU0FBQSxHQUFBLFNBQUEsQ0FBQSxDQUFBLENBQUEsR0FEd0IsU0FBeEJBO0FBRUEsTUFBTUMsaUJBQWlCLEdBQUcsSUFBMUIsR0FBMEIsRUFBMUI7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxJQUE3QixHQUE2QixFQUE3QjtBQUNBLE1BQU1DLG1CQUFtQixHQUFHLElBQTVC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IHRvIGV4dHJhY3Qgb25lIGNoaWxkcmVuJ3Mgd29ydGggb2YgZXZlbnRzIGZyb20gYSBzdHJlYW0gb2YgbmF2aWdhdGlvbiBhY3Rpb24gZXZlbnRzXG4gKlxuICogQmFzZWQgb24gdGhlICdhY3Rpb24nIGV2ZW50cyB0aGF0IGdldCBmaXJlZCBmb3IgdGhpcyBuYXZpZ2F0aW9uIHN0YXRlLCB0aGlzIHV0aWxpdHkgd2lsbCBmaXJlXG4gKiBmb2N1cyBhbmQgYmx1ciBldmVudHMgZm9yIHRoaXMgY2hpbGRcbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZ2V0Q2hpbGRFdmVudFN1YnNjcmliZXIoXG4gIGFkZExpc3RlbmVyLFxuICBrZXksXG4gIGluaXRpYWxMYXN0Rm9jdXNFdmVudCA9ICdkaWRCbHVyJ1xuKSB7XG4gIGNvbnN0IGFjdGlvblN1YnNjcmliZXJzID0gbmV3IFNldCgpO1xuICBjb25zdCB3aWxsRm9jdXNTdWJzY3JpYmVycyA9IG5ldyBTZXQoKTtcbiAgY29uc3QgZGlkRm9jdXNTdWJzY3JpYmVycyA9IG5ldyBTZXQoKTtcbiAgY29uc3Qgd2lsbEJsdXJTdWJzY3JpYmVycyA9IG5ldyBTZXQoKTtcbiAgY29uc3QgZGlkQmx1clN1YnNjcmliZXJzID0gbmV3IFNldCgpO1xuICBjb25zdCByZWZvY3VzU3Vic2NyaWJlcnMgPSBuZXcgU2V0KCk7XG5cbiAgY29uc3QgcmVtb3ZlQWxsID0gKCkgPT4ge1xuICAgIFtcbiAgICAgIGFjdGlvblN1YnNjcmliZXJzLFxuICAgICAgd2lsbEZvY3VzU3Vic2NyaWJlcnMsXG4gICAgICBkaWRGb2N1c1N1YnNjcmliZXJzLFxuICAgICAgd2lsbEJsdXJTdWJzY3JpYmVycyxcbiAgICAgIGRpZEJsdXJTdWJzY3JpYmVycyxcbiAgICAgIHJlZm9jdXNTdWJzY3JpYmVycyxcbiAgICBdLmZvckVhY2goc2V0ID0+IHNldC5jbGVhcigpKTtcblxuICAgIHVwc3RyZWFtU3Vic2NyaWJlcnMuZm9yRWFjaChzdWJzID0+IHN1YnMgJiYgc3Vicy5yZW1vdmUoKSk7XG4gIH07XG5cbiAgY29uc3QgZ2V0Q2hpbGRTdWJzY3JpYmVycyA9IGV2dE5hbWUgPT4ge1xuICAgIHN3aXRjaCAoZXZ0TmFtZSkge1xuICAgICAgY2FzZSAnYWN0aW9uJzpcbiAgICAgICAgcmV0dXJuIGFjdGlvblN1YnNjcmliZXJzO1xuICAgICAgY2FzZSAnd2lsbEZvY3VzJzpcbiAgICAgICAgcmV0dXJuIHdpbGxGb2N1c1N1YnNjcmliZXJzO1xuICAgICAgY2FzZSAnZGlkRm9jdXMnOlxuICAgICAgICByZXR1cm4gZGlkRm9jdXNTdWJzY3JpYmVycztcbiAgICAgIGNhc2UgJ3dpbGxCbHVyJzpcbiAgICAgICAgcmV0dXJuIHdpbGxCbHVyU3Vic2NyaWJlcnM7XG4gICAgICBjYXNlICdkaWRCbHVyJzpcbiAgICAgICAgcmV0dXJuIGRpZEJsdXJTdWJzY3JpYmVycztcbiAgICAgIGNhc2UgJ3JlZm9jdXMnOlxuICAgICAgICByZXR1cm4gcmVmb2N1c1N1YnNjcmliZXJzO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9O1xuXG4gIGNvbnN0IGVtaXQgPSAodHlwZSwgcGF5bG9hZCkgPT4ge1xuICAgIGNvbnN0IHBheWxvYWRXaXRoVHlwZSA9IHsgLi4ucGF5bG9hZCwgdHlwZSB9O1xuICAgIGNvbnN0IHN1YnNjcmliZXJzID0gZ2V0Q2hpbGRTdWJzY3JpYmVycyh0eXBlKTtcbiAgICBzdWJzY3JpYmVycyAmJlxuICAgICAgc3Vic2NyaWJlcnMuZm9yRWFjaChzdWJzID0+IHtcbiAgICAgICAgc3VicyhwYXlsb2FkV2l0aFR5cGUpO1xuICAgICAgfSk7XG4gIH07XG5cbiAgLy8gbGFzdEZvY3VzRXZlbnQga2VlcHMgdHJhY2sgb2YgZm9jdXMgc3RhdGUgZm9yIG9uZSByb3V0ZS4gRmlyc3Qgd2UgYXNzdW1lXG4gIC8vIHdlIGFyZSBibHVycmVkLiBJZiB3ZSBhcmUgZm9jdXNlZCBvbiBpbml0aWFsaXphdGlvbiwgdGhlIGZpcnN0ICdhY3Rpb24nXG4gIC8vIGV2ZW50IHdpbGwgY2F1c2Ugb25Gb2N1cyt3aWxsRm9jdXMgZXZlbnRzIGJlY2F1c2Ugd2UgaGFkIHByZXZpb3VzbHkgYmVlblxuICAvLyBjb25zaWRlcmVkIGJsdXJyZWRcbiAgbGV0IGxhc3RGb2N1c0V2ZW50ID0gaW5pdGlhbExhc3RGb2N1c0V2ZW50O1xuXG4gIGNvbnN0IHVwc3RyZWFtRXZlbnRzID0gW1xuICAgICd3aWxsRm9jdXMnLFxuICAgICdkaWRGb2N1cycsXG4gICAgJ3dpbGxCbHVyJyxcbiAgICAnZGlkQmx1cicsXG4gICAgJ3JlZm9jdXMnLFxuICAgICdhY3Rpb24nLFxuICBdO1xuXG4gIGNvbnN0IHVwc3RyZWFtU3Vic2NyaWJlcnMgPSB1cHN0cmVhbUV2ZW50cy5tYXAoZXZlbnROYW1lID0+XG4gICAgYWRkTGlzdGVuZXIoZXZlbnROYW1lLCBwYXlsb2FkID0+IHtcbiAgICAgIGlmIChldmVudE5hbWUgPT09ICdyZWZvY3VzJykge1xuICAgICAgICBlbWl0KGV2ZW50TmFtZSwgcGF5bG9hZCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgeyBzdGF0ZSwgbGFzdFN0YXRlLCBhY3Rpb24gfSA9IHBheWxvYWQ7XG4gICAgICBjb25zdCBsYXN0Um91dGVzID0gbGFzdFN0YXRlICYmIGxhc3RTdGF0ZS5yb3V0ZXM7XG4gICAgICBjb25zdCByb3V0ZXMgPSBzdGF0ZSAmJiBzdGF0ZS5yb3V0ZXM7XG5cbiAgICAgIC8vIGNvbnN0IGxhc3RGb2N1c0tleSA9XG4gICAgICAvLyAgIGxhc3RTdGF0ZSAmJiBsYXN0U3RhdGUucm91dGVzICYmIGxhc3RTdGF0ZS5yb3V0ZXNbbGFzdFN0YXRlLmluZGV4XS5rZXk7XG4gICAgICBjb25zdCBmb2N1c0tleSA9IHJvdXRlcyAmJiByb3V0ZXNbc3RhdGUuaW5kZXhdLmtleTtcblxuICAgICAgY29uc3QgaXNDaGlsZEZvY3VzZWQgPSBmb2N1c0tleSA9PT0ga2V5O1xuICAgICAgY29uc3QgbGFzdFJvdXRlID1cbiAgICAgICAgbGFzdFJvdXRlcyAmJiBsYXN0Um91dGVzLmZpbmQocm91dGUgPT4gcm91dGUua2V5ID09PSBrZXkpO1xuICAgICAgY29uc3QgbmV3Um91dGUgPSByb3V0ZXMgJiYgcm91dGVzLmZpbmQocm91dGUgPT4gcm91dGUua2V5ID09PSBrZXkpO1xuICAgICAgY29uc3QgY2hpbGRQYXlsb2FkID0ge1xuICAgICAgICBjb250ZXh0OiBgJHtrZXl9OiR7YWN0aW9uLnR5cGV9XyR7cGF5bG9hZC5jb250ZXh0IHx8ICdSb290J31gLFxuICAgICAgICBzdGF0ZTogbmV3Um91dGUsXG4gICAgICAgIGxhc3RTdGF0ZTogbGFzdFJvdXRlLFxuICAgICAgICBhY3Rpb24sXG4gICAgICAgIHR5cGU6IGV2ZW50TmFtZSxcbiAgICAgIH07XG4gICAgICBjb25zdCBpc1RyYW5zaXRpb25pbmcgPSAhIXN0YXRlICYmIHN0YXRlLmlzVHJhbnNpdGlvbmluZztcblxuICAgICAgY29uc3QgcHJldmlvdXNseWxhc3RGb2N1c0V2ZW50ID0gbGFzdEZvY3VzRXZlbnQ7XG5cbiAgICAgIGlmIChsYXN0Rm9jdXNFdmVudCA9PT0gJ2RpZEJsdXInKSB7XG4gICAgICAgIC8vIFRoZSBjaGlsZCBpcyBjdXJyZW50bHkgYmx1cnJlZC4gTG9vayBmb3Igd2lsbEZvY3VzIGNvbmRpdGlvbnNcbiAgICAgICAgaWYgKGV2ZW50TmFtZSA9PT0gJ3dpbGxGb2N1cycgJiYgaXNDaGlsZEZvY3VzZWQpIHtcbiAgICAgICAgICBlbWl0KChsYXN0Rm9jdXNFdmVudCA9ICd3aWxsRm9jdXMnKSwgY2hpbGRQYXlsb2FkKTtcbiAgICAgICAgfSBlbHNlIGlmIChldmVudE5hbWUgPT09ICdhY3Rpb24nICYmIGlzQ2hpbGRGb2N1c2VkKSB7XG4gICAgICAgICAgZW1pdCgobGFzdEZvY3VzRXZlbnQgPSAnd2lsbEZvY3VzJyksIGNoaWxkUGF5bG9hZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChsYXN0Rm9jdXNFdmVudCA9PT0gJ3dpbGxGb2N1cycpIHtcbiAgICAgICAgLy8gV2UgYXJlIGN1cnJlbnRseSBtaWQtZm9jdXMuIExvb2sgZm9yIGRpZEZvY3VzIGNvbmRpdGlvbnMuXG4gICAgICAgIC8vIElmIHN0YXRlLmlzVHJhbnNpdGlvbmluZyBpcyBmYWxzZSwgdGhpcyBjaGlsZCBldmVudCBoYXBwZW5zIGltbWVkaWF0ZWx5IGFmdGVyIHdpbGxGb2N1c1xuICAgICAgICBpZiAoZXZlbnROYW1lID09PSAnZGlkRm9jdXMnICYmIGlzQ2hpbGRGb2N1c2VkICYmICFpc1RyYW5zaXRpb25pbmcpIHtcbiAgICAgICAgICBlbWl0KChsYXN0Rm9jdXNFdmVudCA9ICdkaWRGb2N1cycpLCBjaGlsZFBheWxvYWQpO1xuICAgICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAgIGV2ZW50TmFtZSA9PT0gJ2FjdGlvbicgJiZcbiAgICAgICAgICBpc0NoaWxkRm9jdXNlZCAmJlxuICAgICAgICAgICFpc1RyYW5zaXRpb25pbmdcbiAgICAgICAgKSB7XG4gICAgICAgICAgZW1pdCgobGFzdEZvY3VzRXZlbnQgPSAnZGlkRm9jdXMnKSwgY2hpbGRQYXlsb2FkKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAobGFzdEZvY3VzRXZlbnQgPT09ICdkaWRGb2N1cycpIHtcbiAgICAgICAgLy8gVGhlIGNoaWxkIGlzIGN1cnJlbnRseSBmb2N1c2VkLiBMb29rIGZvciBibHVycmluZyBldmVudHNcbiAgICAgICAgaWYgKCFpc0NoaWxkRm9jdXNlZCkge1xuICAgICAgICAgIC8vIFRoZSBjaGlsZCBpcyBubyBsb25nZXIgZm9jdXNlZCB3aXRoaW4gdGhpcyBuYXZpZ2F0aW9uIHN0YXRlXG4gICAgICAgICAgZW1pdCgobGFzdEZvY3VzRXZlbnQgPSAnd2lsbEJsdXInKSwgY2hpbGRQYXlsb2FkKTtcbiAgICAgICAgfSBlbHNlIGlmIChldmVudE5hbWUgPT09ICd3aWxsQmx1cicpIHtcbiAgICAgICAgICAvLyBUaGUgcGFyZW50IGlzIGdldHRpbmcgYSB3aWxsQmx1ciBldmVudFxuICAgICAgICAgIGVtaXQoKGxhc3RGb2N1c0V2ZW50ID0gJ3dpbGxCbHVyJyksIGNoaWxkUGF5bG9hZCk7XG4gICAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgICAgZXZlbnROYW1lID09PSAnYWN0aW9uJyAmJlxuICAgICAgICAgIHByZXZpb3VzbHlsYXN0Rm9jdXNFdmVudCA9PT0gJ2RpZEZvY3VzJ1xuICAgICAgICApIHtcbiAgICAgICAgICAvLyBXaGlsZSBmb2N1c2VkLCBwYXNzIGFjdGlvbiBldmVudHMgdG8gY2hpbGRyZW4gZm9yIGdyYW5kY2hpbGRyZW4gZm9jdXNcbiAgICAgICAgICBlbWl0KCdhY3Rpb24nLCBjaGlsZFBheWxvYWQpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChsYXN0Rm9jdXNFdmVudCA9PT0gJ3dpbGxCbHVyJykge1xuICAgICAgICAvLyBUaGUgY2hpbGQgaXMgbWlkLWJsdXIuIFdhaXQgZm9yIHRyYW5zaXRpb24gdG8gZW5kXG4gICAgICAgIGlmIChldmVudE5hbWUgPT09ICdhY3Rpb24nICYmICFpc0NoaWxkRm9jdXNlZCAmJiAhaXNUcmFuc2l0aW9uaW5nKSB7XG4gICAgICAgICAgLy8gVGhlIGNoaWxkIGlzIGRvbmUgYmx1cnJpbmcgYmVjYXVzZSB0cmFuc2l0aW9uaW5nIGlzIG92ZXIsIG9yIGlzVHJhbnNpdGlvbmluZ1xuICAgICAgICAgIC8vIG5ldmVyIGJlZ2FuIGFuZCBkaWRCbHVyIGZpcmVzIGltbWVkaWF0ZWx5IGFmdGVyIHdpbGxCbHVyXG4gICAgICAgICAgZW1pdCgobGFzdEZvY3VzRXZlbnQgPSAnZGlkQmx1cicpLCBjaGlsZFBheWxvYWQpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50TmFtZSA9PT0gJ2RpZEJsdXInKSB7XG4gICAgICAgICAgLy8gUGFzcyB0aHJvdWdoIHRoZSBwYXJlbnQgZGlkQmx1ciBldmVudCBpZiBpdCBoYXBwZW5zXG4gICAgICAgICAgZW1pdCgobGFzdEZvY3VzRXZlbnQgPSAnZGlkQmx1cicpLCBjaGlsZFBheWxvYWQpO1xuICAgICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAgIGV2ZW50TmFtZSA9PT0gJ2FjdGlvbicgJiZcbiAgICAgICAgICBpc0NoaWxkRm9jdXNlZCAmJlxuICAgICAgICAgICFpc1RyYW5zaXRpb25pbmdcbiAgICAgICAgKSB7XG4gICAgICAgICAgZW1pdCgobGFzdEZvY3VzRXZlbnQgPSAnZGlkRm9jdXMnKSwgY2hpbGRQYXlsb2FkKTtcbiAgICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgICBldmVudE5hbWUgPT09ICdhY3Rpb24nICYmXG4gICAgICAgICAgaXNDaGlsZEZvY3VzZWQgJiZcbiAgICAgICAgICBpc1RyYW5zaXRpb25pbmdcbiAgICAgICAgKSB7XG4gICAgICAgICAgZW1pdCgobGFzdEZvY3VzRXZlbnQgPSAnd2lsbEZvY3VzJyksIGNoaWxkUGF5bG9hZCk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGxhc3RGb2N1c0V2ZW50ID09PSAnZGlkQmx1cicgJiYgIW5ld1JvdXRlKSB7XG4gICAgICAgIHJlbW92ZUFsbCgpO1xuICAgICAgfVxuICAgIH0pXG4gICk7XG5cbiAgcmV0dXJuIHtcbiAgICBhZGRMaXN0ZW5lcihldmVudE5hbWUsIGV2ZW50SGFuZGxlcikge1xuICAgICAgY29uc3Qgc3Vic2NyaWJlcnMgPSBnZXRDaGlsZFN1YnNjcmliZXJzKGV2ZW50TmFtZSk7XG4gICAgICBpZiAoIXN1YnNjcmliZXJzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBldmVudCBuYW1lIFwiJHtldmVudE5hbWV9XCJgKTtcbiAgICAgIH1cbiAgICAgIHN1YnNjcmliZXJzLmFkZChldmVudEhhbmRsZXIpO1xuICAgICAgY29uc3QgcmVtb3ZlID0gKCkgPT4ge1xuICAgICAgICBzdWJzY3JpYmVycy5kZWxldGUoZXZlbnRIYW5kbGVyKTtcbiAgICAgIH07XG4gICAgICByZXR1cm4geyByZW1vdmUgfTtcbiAgICB9LFxuICAgIGVtaXQoZXZlbnROYW1lLCBwYXlsb2FkKSB7XG4gICAgICBpZiAoZXZlbnROYW1lICE9PSAncmVmb2N1cycpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgICBgbmF2aWdhdGlvbi5lbWl0IG9ubHkgc3VwcG9ydHMgdGhlICdyZWZvY3VzJyBldmVudCBjdXJyZW50bHkuYFxuICAgICAgICApO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBlbWl0KGV2ZW50TmFtZSwgcGF5bG9hZCk7XG4gICAgfSxcbiAgfTtcbn1cbiJdfQ==